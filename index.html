<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOTU WORLD : OC ARCHIVE</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==">
    <style>
        /* [1] SYSTEM VARIABLES & RESET */
        :root {
            --bg-deep: #0a0a0c;
            --bg-panel: rgba(30, 30, 35, 0.95);
            --neon-blue: #00f0ff; 
            --neon-yellow: #ffd700;
            --neon-red: #ff4444;
            --text-main: #ffffff;
            --text-sub: #8492a6;
            --border-cut: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        #app { display: flex; height: 100%; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        .sidebar {
            width: 250px;
            background: #111;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            z-index: 10;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #222;
        }

        .sys-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid #444;
            color: #666;
            width: 100%;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-family: monospace;
            font-size: 11px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s;
            letter-spacing: 1px;
        }

        .sys-btn:hover {
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
            background: rgba(255, 215, 0, 0.05);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            color: var(--neon-yellow);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 40px;
            letter-spacing: -1px;
            font-style: italic;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid #333;
            color: var(--text-sub);
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
            cursor: pointer;
            transition: 0.3s;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 calc(100% - 10px));
            font-family: monospace;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--neon-blue);
            color: var(--neon-blue);
            padding-left: 25px;
        }

        /* Main Content Area */
        .content-area { flex: 1; position: relative; overflow-y: auto; padding: 40px; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2.page-title {
            font-size: 36px;
            border-bottom: 2px solid var(--neon-blue);
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-transform: uppercase;
        }

        /* [SECTION 1] CHARACTER LIST */
        .filter-bar { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .filter-tag { position: relative; background: #222; border: 1px solid #444; color: #aaa; padding: 5px 15px; cursor: pointer; font-size: 12px; display: flex; align-items: center; transition: 0.2s; }
        .filter-tag.active { color: #000; font-weight: bold; } 
        .filter-tag .del-cat-btn { margin-left: 8px; color: inherit; font-weight: bold; cursor: pointer; display: none; opacity: 0.6; }
        .filter-tag:hover .del-cat-btn { display: block; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
        .char-card {
            background: var(--bg-panel);
            height: 320px;
            position: relative;
            clip-path: var(--border-cut);
            border-top: 2px solid var(--neon-blue);
            cursor: pointer;
            transition: 0.3s;
        }
        .char-card:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(0, 240, 255, 0.3); }
.card-img { 
    width: 100%; 
    height: 65%; 
    background-color: #222; 
    background-size: cover;       /* ê½‰ ì±„ìš°ê¸° (í™•ëŒ€ë¨) */
    background-position: top center; /* ë¬´ì¡°ê±´ ìœ„ìª½(ì–¼êµ´)ì„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ */
    background-repeat: no-repeat;
}
        .card-info { padding: 15px; }
        .card-name { font-size: 20px; font-weight: bold; color: #fff; display: block; }
        .card-meta { font-size: 11px; color: var(--neon-yellow); margin-top: 4px; display: block; text-transform: uppercase; }
        .card-team-icon { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; border: 1px solid var(--neon-blue); border-radius: 4px;}
        
        .card-delete-btn {
            position: absolute; top: 0; right: 0;
            width: 30px; height: 30px;
            background: transparent;
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            border: none;
            cursor: pointer;
            z-index: 5;
            opacity: 0;
            transition: 0.2s;
        }
        .char-card:hover .card-delete-btn { opacity: 1; background: rgba(255, 68, 68, 0.8); }

        /* [SECTION 2] CHARACTER DETAIL - SPLIT LAYOUT */
        .detail-container { display: flex; gap: 40px; height: 85vh; }

        .detail-visual {
            flex: 1.8;
            display: flex;
            gap: 15px;
            height: 100%;
        }

        .visual-fullbody {
            flex: 2;
            position: relative;
            background: radial-gradient(circle at center bottom, rgba(0,240,255,0.1) 0%, rgba(0,0,0,0) 60%);
            border: 1px solid #333;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
        }

        #detail-name-bg {
            position: absolute; 
            top: 100%;
            left: 0px;
            padding-left: 20px;
            padding-top: 10px;
            font-size: 100px; 
            opacity: 0.12; 
            font-style: italic; 
            font-weight: 900;
            white-space: nowrap; 
            line-height: 1; 
            transform: rotate(-90deg);
            transform-origin: top left;
            pointer-events: none; 
            z-index: 1; 
            color: #fff;
            text-transform: uppercase;
            font-family: 'Arial Black', sans-serif;
        }

        #detail-char-img {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 105%;
            width: auto;
            max-width: none;
            z-index: 2;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #detail-char-img img {
            height: 100%;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));
        }

        .visual-portrait-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .portrait-frame {
            width: 100%;
            aspect-ratio: 1 / 1; 
            background: #111;
            border: 2px solid var(--neon-blue);
            position: relative;
            overflow: hidden;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        }

        #detail-portrait-img {
            width: 100%; height: 100%;
            background-size: cover; background-position: top center;
            transition: 0.3s;
        }

        .portrait-info {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
            padding: 15px;
            font-size: 12px;
            color: var(--text-sub);
            display: flex; flex-direction: column; gap: 5px;
        }

        .detail-data { flex: 1.2; position: relative; overflow-y: auto; padding-right: 10px; }

        /* TABS */
        .detail-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #333; align-items: flex-end; }
        .tab-btn {
            padding: 10px 20px; background: transparent; border: none; color: var(--text-sub); 
            font-weight: bold; cursor: pointer; transition: 0.3s;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: var(--neon-blue); border-bottom-color: var(--neon-blue); }
        
        .tab-edit-btn {
            margin-left: auto;
            background: rgba(0,0,0,0.5);
            border: 1px solid #333;
            color: var(--neon-yellow);
            width: 36px; height: 36px;
            border-radius: 4px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            transition: 0.3s;
        }
        .tab-edit-btn:hover {
            border-color: var(--neon-yellow);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            background: rgba(255, 215, 0, 0.1);
        }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Leader Badge */
        .leader-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #000;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* TAB 1: ID */
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; font-size: 14px; color: var(--text-sub); }
        .profile-grid li { list-style: none; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .profile-grid b { color: var(--neon-blue); margin-right: 8px; }

        /* TAB 3: META */
        .weapon-box {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1) 0%, transparent 100%);
            border-left: 4px solid var(--neon-yellow);
            padding: 15px; margin: 20px 0;
        }

        /* TAB 4: RELATION (EDITABLE) */
        .rel-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .rel-table th { text-align: left; color: var(--neon-blue); padding: 10px; border-bottom: 1px solid #444; }
        .rel-table td { padding: 10px; border-bottom: 1px solid #222; color: var(--text-sub); }
        .rel-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; border: 1px solid transparent; }
        
        .rel-editor { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid #333; }
        .rel-form { display: flex; gap: 10px; align-items: flex-end; }
        .rel-input { background: #222; border: 1px solid #444; color: #fff; padding: 8px; font-size: 13px; width: 100%; }
        .btn-small { padding: 8px 15px; cursor: pointer; border: none; font-weight: bold; font-size: 12px; }
        .btn-add { background: var(--neon-blue); color: #000; }
        .btn-del { background: #333; color: #ff4444; padding: 5px 10px; }

        /* [SECTION 3] WORLD VIEW - ACCORDION */
        .accordion-item { border: 1px solid #333; margin-bottom: 10px; background: rgba(255,255,255,0.02); }
        .accordion-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; align-items: center; min-height: 50px;}
        .accordion-header:hover { background: rgba(0,240,255,0.05); }
        .accordion-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: 0.3s ease-out; color: var(--text-sub); font-size: 14px; }
        .accordion-item.open .accordion-content { padding: 15px; max-height: 200px; border-top: 1px solid #333; }
        
        .term-controls { display: flex; gap: 8px; font-size: 14px; align-items: center;}
        .term-btn { background: transparent; border: none; cursor: pointer; font-size: 16px; color: var(--text-sub); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }

        .inline-input-title { background: #222; border: 1px solid var(--neon-blue); color: #fff; padding: 5px 10px; font-weight: bold; width: 70%; font-size: 15px; }
        .inline-input-desc { width: 100%; height: 80px; background: #222; border: 1px solid var(--neon-blue); color: #ccc; padding: 10px; font-family: inherit; resize: vertical; margin-bottom: 10px; }

        /* [SECTION 4] RELATIONSHIP MAP & LEGEND */
        .rel-container { display: flex; height: 600px; border: 1px solid #333; position: relative; }
        .rel-sidebar { width: 200px; background: #0f0f11; border-right: 1px solid #333; overflow-y: auto; padding: 10px; }
        .rel-char-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .rel-char-item:hover, .rel-char-item.active { background: rgba(0, 240, 255, 0.1); color: var(--neon-blue); }
        .rel-char-thumb { width: 30px; height: 30px; background: #333; border-radius: 50%; }
        
        #rel-canvas-wrap { flex: 1; position: relative; background: #0f0f11; overflow: hidden; }
        .rel-node {
            position: absolute; width: 70px; height: 70px; background: #222; border: 2px solid var(--text-sub); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 11px; color: #fff; cursor: pointer; z-index: 2;
            transition: all 0.3s ease;
        }
        .rel-node.main { width: 90px; height: 90px; border-color: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue); font-weight: bold; }

        /* LEGEND BOX */
        .legend-box {
            position: absolute; bottom: 20px; right: 20px; 
            background: rgba(0,0,0,0.8); border: 1px solid #444; 
            padding: 15px; width: 150px; z-index: 5;
            backdrop-filter: blur(4px);
        }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 12px; color: #ccc; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }

        /* [MODAL COMMON] */
        #inputModal, #catModal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.85); z-index:9999; 
            align-items:center; justify-content:center; backdrop-filter: blur(5px);
        }
        
        /* [MODAL NEW LAYOUT] */
        .modal-content {
            background:#1a1a1d; border:2px solid var(--neon-blue); 
            width:90%; max-width:900px; height: 80vh; 
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); 
            position:relative; display: flex; overflow: hidden; padding: 0;
        }

        .modal-sidebar {
            width: 200px; background: #111; border-right: 1px solid #333;
            display: flex; flex-direction: column; padding: 20px 0;
        }
        .modal-nav-btn {
            background: transparent; border: none; color: #666; padding: 15px 20px;
            text-align: left; cursor: pointer; font-weight: bold; font-size: 13px;
            transition: 0.2s; border-left: 3px solid transparent;
        }
        .modal-nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .modal-nav-btn.active { color: var(--neon-blue); border-left-color: var(--neon-blue); background: rgba(0, 240, 255, 0.05); }

        .modal-body-area { flex: 1; padding: 30px; overflow-y: auto; }
        
        .edit-section { display: none; animation: fadeIn 0.3s; }
        .edit-section.active { display: block; }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .form-group label { display:block; font-size:11px; color: var(--text-sub); margin-bottom:5px; text-transform: uppercase;}
        .form-group input, .form-group textarea, .form-group select {
            width:100%; background:#222; border:1px solid #444; color:#fff; padding:10px; border-radius:2px;
            font-size: 13px;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--neon-yellow); }
        .form-group input[type="color"] { height: 40px; cursor: pointer; padding: 2px; }
        .form-group input[type="checkbox"] { width: auto; margin-right: 5px; transform: scale(1.2); }

        .btn-primary { padding:15px; background:var(--neon-blue); color:#000; border:none; cursor:pointer; font-weight:bold; width: 100%; clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 calc(100% - 10px)); }
        .btn-secondary { padding:15px; background:#333; color:#fff; border:none; cursor:pointer; width: 100%; clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 calc(100% - 10px)); }

        /* [USER STATUS BAR] */
        #user-status {
            position: fixed;
            top: 20px;
            right: 30px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(10, 10, 12, 0.9);
            border: 1px solid var(--neon-blue);
            padding: 8px 15px;
            border-radius: 4px;
            backdrop-filter: blur(5px);
            font-family: monospace;
            transition: 0.3s;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #user-status:hover { border-color: var(--neon-yellow); }

        #detail-char-img {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 95%;
            width: auto;
            max-width: 90%;
            z-index: 2;
            pointer-events: none;
            transition: opacity 0.5s ease;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom center;
        }

        /* [PASSWORD OVERLAY] */
        #password-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-deep); z-index: 10000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* [MUSIC PLAYER & SETTINGS] */
        .music-control {
            display: flex; align-items: center; gap: 10px;
            margin-right: 15px; padding-right: 15px; border-right: 1px solid #333;
        }
        .music-btn {
            background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue);
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .music-btn:hover { background: var(--neon-blue); color: #000; }
        .music-visualizer {
            display: flex; gap: 2px; align-items: flex-end; height: 15px; width: 30px;
        }
        .music-bar {
            width: 4px; background: var(--neon-yellow); animation: equalize 1s infinite;
        }
        .music-bar:nth-child(1) { animation-delay: 0.1s; height: 40%; }
        .music-bar:nth-child(2) { animation-delay: 0.3s; height: 80%; }
        .music-bar:nth-child(3) { animation-delay: 0.5s; height: 50%; }
        .music-bar:nth-child(4) { animation-delay: 0.2s; height: 90%; }
        @keyframes equalize {
            0%, 100% { height: 20%; } 50% { height: 100%; }
        }
        .music-paused .music-bar { animation: none; height: 2px; }

        /* SETTINGS BTN */
        .settings-btn {
            background: transparent; border: none; color: var(--text-sub); 
            font-size: 14px; cursor: pointer; transition: 0.3s;
        }
        .settings-btn:hover { color: #fff; transform: rotate(90deg); }

        /* [NEW] CHARACTER LIST REDESIGN */
        .stat-header {
            display: flex; gap: 20px; margin-bottom: 30px;
            background: rgba(0,0,0,0.3); padding: 20px; border: 1px solid #333;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }
        .stat-box { flex: 1; border-left: 3px solid var(--neon-blue); padding-left: 15px; }
        .stat-box h4 { color: var(--text-sub); font-size: 11px; margin-bottom: 5px; }
        .stat-box span { color: #fff; font-size: 24px; font-weight: bold; font-family: 'Arial Black'; }

        /* ìƒˆë¡œìš´ íŒ€ í•„í„° ì¹© ìŠ¤íƒ€ì¼ */
        .team-chip {
            display: flex; align-items: center;
            background: #1a1a1d; border: 1px solid #333;
            padding: 0; margin-right: 10px; margin-bottom: 10px;
            cursor: pointer; transition: 0.3s;
            overflow: hidden; height: 40px;
        }
        .team-chip:hover, .team-chip.active {
            border-color: var(--neon-blue);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .team-chip-color { width: 6px; height: 100%; background: #555; transition: 0.3s; }
        .team-chip-name { padding: 0 15px; color: #aaa; font-size: 13px; font-weight: bold; }
        .team-chip.active .team-chip-name { color: #fff; }
        .team-chip-count { 
            background: #000; color: #666; height: 100%; 
            padding: 0 15px; display: flex; align-items: center; 
            font-size: 11px; border-left: 1px solid #333; 
        }
        .team-chip:hover .team-chip-count, .team-chip.active .team-chip-count { color: var(--neon-blue); }

        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes modalSlide { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content { animation: modalSlide 0.3s ease-out; }


/* [ERROR MODE STYLES] */
body.error-mode {
    --neon-blue: #ff0000 !important;   /* íŒŒë€ìƒ‰ -> ë¹¨ê°„ìƒ‰ */
    --neon-yellow: #ff3333 !important; /* ë…¸ë€ìƒ‰ -> ë¶‰ì€ ì£¼í™©ìƒ‰ */
    --bg-deep: #110505 !important;     /* ë°°ê²½ -> ë¶‰ì€ ê²€ì • */
    --text-sub: #aa5555 !important;
}

body.error-mode .logo {
    animation: glitch-anim 0.3s infinite;
    color: #ff0000;
    text-shadow: 2px 2px #000, -2px -2px #ff3333;
}

/* ì—ëŸ¬ ë°•ìŠ¤ ë””ìì¸ */
.error-popup-box {
    position: fixed;
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid #ff0000;
    color: #ff0000;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 12px;
    z-index: 99999;
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    animation: popIn 0.2s ease-out;
    pointer-events: none; /* í´ë¦­ ë°©ì§€ (ì‚¬ìš© ë°©í•´ X) */
    max-width: 250px;
}

.error-popup-box::before {
    content: "âš  SYSTEM WARNING";
    display: block;
    background: #ff0000;
    color: #000;
    padding: 2px 5px;
    margin-bottom: 8px;
    font-size: 10px;
}

@keyframes glitch-anim {
    0% { transform: translate(0) }
    20% { transform: translate(-2px, 2px) }
    40% { transform: translate(-2px, -2px) }
    60% { transform: translate(2px, 2px) }
    80% { transform: translate(2px, -2px) }
    100% { transform: translate(0) }
}
@keyframes popIn {
    from { transform: scale(0); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* [MYSTERY ERROR POPUP] */
.center-error-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8); /* ë°°ê²½ì„ ì–´ë‘¡ê²Œ ì²˜ë¦¬ */
    z-index: 99998;
    backdrop-filter: blur(2px);
}

.center-error-box {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%); /* ì •ì¤‘ì•™ ì •ë ¬ */
    background: #000;
    border: 2px solid #fff;
    padding: 40px 60px;
    text-align: center;
    z-index: 99999;
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
    animation: popIn 0.3s ease-out;
}

.center-error-text {
    color: #fff;
    font-size: 24px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    letter-spacing: 2px;
    margin-bottom: 30px;
    text-shadow: 0 0 5px #fff;
}

.center-close-btn {
    background: transparent;
    border: 1px solid #555;
    color: #555;
    padding: 8px 20px;
    cursor: pointer;
    font-family: monospace;
    font-size: 12px;
    transition: 0.3s;
}

.center-close-btn:hover {
    border-color: #fff;
    color: #fff;
    background: rgba(255,255,255,0.1);
}

/* [ANGEL MODE] - ì™„ì „ í‘ë°±/ê³ ëŒ€ë¹„ ëª¨ë“œ (í° ê¸€ì”¨ ê°•ì œ ì œê±°) */
body.angel-mode {
    --bg-deep: #ffffff !important;
    --bg-panel: #ffffff !important;
    --neon-blue: #000000 !important;   /* í¬ì¸íŠ¸ ì»¬ëŸ¬ -> ê²€ì • */
    --neon-yellow: #333333 !important; /* ë³´ì¡° ì»¬ëŸ¬ -> ì§™ì€ íšŒìƒ‰ */
    --neon-red: #555555 !important;
    --text-main: #000000 !important;
    --text-sub: #333333 !important;
    
    background-color: #ffffff !important;
    background-image: none !important; /* ë°°ê²½ ê²©ì ì œê±° */
}

/* [í•µì‹¬] ëª¨ë“  ìš”ì†Œì˜ ê¸€ììƒ‰ì„ ê²€ì •ìœ¼ë¡œ ê°•ì œ ë³€ê²½ (!importantë¡œ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸°) */
body.angel-mode * {
    color: #000000 !important;
    text-shadow: none !important; /* ë„¤ì˜¨ ë¹› ë²ˆì§ íš¨ê³¼ ì œê±° */
    box-shadow: none !important;  /* ë°•ìŠ¤ ê·¸ë¦¼ì ì œê±° */
}

/* íŠ¹ì • ìš”ì†Œë“¤ì˜ ë°°ê²½ ë° í…Œë‘ë¦¬ ì •ë¦¬ */
body.angel-mode .sidebar,
body.angel-mode .modal-content,
body.angel-mode .char-card,
body.angel-mode .stat-header,
body.angel-mode #team-info-card,
body.angel-mode .data-box,
body.angel-mode .accordion-content,
body.angel-mode .rel-node {
    background: #ffffff !important;
    border: 1px solid #000000 !important; /* í…Œë‘ë¦¬ë¥¼ ì§„í•˜ê²Œ */
}

/* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (í° ë°°ê²½, ê²€ì€ í…Œë‘ë¦¬) */
body.angel-mode input,
body.angel-mode textarea,
body.angel-mode select {
    background: #f8f8f8 !important;
    border: 1px solid #000000 !important;
    color: #000000 !important;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œë§Œ ë°˜ì „) */
body.angel-mode .nav-btn,
body.angel-mode .sys-btn,
body.angel-mode .filter-tag,
body.angel-mode .tab-btn {
    background: #ffffff !important;
    border: 1px solid #000000 !important;
    color: #000000 !important;
}

body.angel-mode .nav-btn.active,
body.angel-mode .nav-btn:hover,
body.angel-mode .filter-tag.active,
body.angel-mode .tab-btn.active {
    background: #000000 !important;     /* ì„ íƒëœ ê±´ ê²€ì€ ë°°ê²½ */
    color: #ffffff !important;           /* ì„ íƒëœ ê±´ í° ê¸€ì”¨ */
}
/* ì„ íƒëœ ë²„íŠ¼ ë‚´ë¶€ì˜ ìì‹ ìš”ì†Œë„ í°ìƒ‰ìœ¼ë¡œ (ì¤‘ìš”) */
body.angel-mode .nav-btn.active *,
body.angel-mode .nav-btn:hover *,
body.angel-mode .filter-tag.active * {
    color: #ffffff !important;
}

/* ê´€ê³„ë„ ì„  ìƒ‰ìƒ ê°•ì œ ë³€ê²½ (CanvasëŠ” CSSë¡œ ì•ˆë˜ì§€ë§Œ, ë…¸ë“œëŠ” ë³€ê²½) */
body.angel-mode .rel-node {
    background: #fff !important;
    border-color: #000 !important;
}

/* ê±°ëŒ€ ë°°ê²½ ê¸€ì”¨ (ë„ˆë¬´ ì§„í•˜ë©´ ë°©í•´ë˜ë¯€ë¡œ ì—°í•œ íšŒìƒ‰) */
body.angel-mode #detail-name-bg {
    color: #f0f0f0 !important;
    opacity: 1 !important;
}

/* 7. [ì¶”ê°€] ì¹´í…Œê³ ë¦¬ íŒ€ ì´ë¦„ (ê¸°ë³¸ íšŒìƒ‰, ì„ íƒ ì‹œ í°ìƒ‰) */
body.angel-mode .team-chip .team-chip-name {
    color: #888888 !important; 
}
body.angel-mode .team-chip.active .team-chip-name {
    color: #ffffff !important; 
}

/* 8. [ì¶”ê°€] ê´€ê³„ë„ í˜ì´ì§€ ìºë¦­í„° ëª©ë¡ (ê¸°ë³¸ íšŒìƒ‰, ë§ˆìš°ìŠ¤ì˜¤ë²„/ì„ íƒ ì‹œ ê²€ì • ë°°ê²½ì— í° ê¸€ì”¨) */
body.angel-mode .rel-char-item {
    color: #888888 !important;
}
body.angel-mode .rel-char-item:hover, 
body.angel-mode .rel-char-item.active {
    color: #ffffff !important;
    background: #000000 !important; /* ë„¤ì˜¨ ë¸”ë£¨ ë°°ê²½ì„ ê²€ì •ìƒ‰ìœ¼ë¡œ ë®ì–´ì”Œì›€ */
}

/* 9. [ì¶”ê°€] ê´€ê³„ ì²™ë„ ì´ë¦„ (ë””í…Œì¼ ë±ƒì§€, ê´€ê³„ë„ ë…¸ë“œ íƒœê·¸, ë²”ë¡€ í…ìŠ¤íŠ¸) */
body.angel-mode .rel-badge,
body.angel-mode .rel-node span,
body.angel-mode .legend-item,
body.angel-mode .legend-item span {
    color: #888888 !important;
    border-color: #888888 !important; /* ë±ƒì§€ í…Œë‘ë¦¬ë„ íšŒìƒ‰ìœ¼ë¡œ í†µì¼ */
}

/* 10. (ë³´ë„ˆìŠ¤) ì¹©ê³¼ ë²”ë¡€ì˜ ì»¬ëŸ¬ ë°•ìŠ¤ ìì²´ë„ íšŒìƒ‰ìœ¼ë¡œ ë¹¼ê³  ì‹¶ë‹¤ë©´ ì ìš© */
body.angel-mode .legend-color,
body.angel-mode .team-chip-color {
    background-color: #555555 !important;
}

/* =========================================================
   [ANGEL MODE] ì¶”ê°€ ìš”ì²­ ë³´ì™„ ì‚¬í•­ 
   ========================================================= */

/* 1. ê´€ê³„ë„ í˜ì´ì§€ ìºë¦­í„° ëª©ë¡ ì´ë¦„ (í°ìƒ‰ìœ¼ë¡œ ë³€ê²½) */
body.angel-mode .rel-char-item {
    color: #ffffff !important; /* ê¸€ììƒ‰ í°ìƒ‰ */
    background: #444444 !important; /* ê°€ë…ì„±ì„ ìœ„í•´ ë°°ê²½ì„ ì¡°ê¸ˆ ë” ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ */
    border-bottom: 1px solid #555555 !important;
}

/* ê´€ê³„ë„ ëª©ë¡ ë§ˆìš°ìŠ¤ ì˜¤ë²„/ì„ íƒ ì‹œ */
body.angel-mode .rel-char-item:hover, 
body.angel-mode .rel-char-item.active {
    background: #000000 !important; /* ë°°ê²½ ê²€ì • */
    color: #ffffff !important; /* ê¸€ì í°ìƒ‰ ìœ ì§€ */
}

/* 2. ìƒë‹¨ ìœ ì € ìƒíƒœë°” (ê¸€ì ë° ì•„ì´ì½˜ í°ìƒ‰ ë°˜ì „) */
body.angel-mode #user-status {
    background: #000000 !important; /* ë°” ë°°ê²½ì„ ê²€ì •ìœ¼ë¡œ ë³€ê²½ */
    border: 1px solid #ffffff !important; /* í…Œë‘ë¦¬ í°ìƒ‰ */
    color: #ffffff !important; /* ê¸°ë³¸ ê¸€ì í°ìƒ‰ */
}

/* ìœ ì € ìƒíƒœë°” ë‚´ë¶€ì˜ ë¼ë²¨(OPERATOR : )ê³¼ ì´ë¦„ */
body.angel-mode #user-status span {
    color: #ffffff !important;
}

/* ìœ ì € ìƒíƒœë°” ì•„ì´ì½˜(ë™ê·¸ë¼ë¯¸ í¬ì¸íŠ¸) ìƒ‰ìƒ í°ìƒ‰ìœ¼ë¡œ */
body.angel-mode #user-status div[style*="background: var(--neon-blue)"] {
    background: #ffffff !important;
    box-shadow: 0 0 10px #ffffff !important;
}

/* 3. ë®¤ì§ í”Œë ˆì´ì–´ ì•„ì´ì½˜ ë° ë¹„ì£¼ì–¼ë¼ì´ì € */
body.angel-mode .music-btn {
    border-color: #ffffff !important;
    color: #ffffff !important;
}
body.angel-mode .music-bar {
    background: #ffffff !important; /* ë¹„ì£¼ì–¼ë¼ì´ì € ë§‰ëŒ€ í°ìƒ‰ */
}

/* 4. ê´€ê³„ë„ ë…¸ë“œ ë° ì²™ë„ í…ìŠ¤íŠ¸ (í°ìƒ‰ ìœ ì§€) */
body.angel-mode .rel-node span,
body.angel-mode .legend-item,
body.angel-mode .legend-item span {
    color: #ffffff !important;
}

</style>
</head>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiS0NKi6QeQFEUlHQQDNKWbqoxopUhbEI",
    authDomain: "autocoworld.firebaseapp.com",
    databaseURL: "https://autocoworld-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "autocoworld",
    storageBucket: "autocoworld.firebasestorage.app",
    messagingSenderId: "785293756397",
    appId: "1:785293756397:web:561f55be8f137b136d09e4",
    measurementId: "G-8K6Q3H0JGX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // [ì¤‘ìš”] ì €ì¥ í•¨ìˆ˜: window ê°ì²´ì— ìˆëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì €ì¥
  window.saveToFirebase = function() {
    const dataToSave = {
      charDB: window.charDB || [],
      categoryDB: window.categoryDB || [],
      termDB: window.termDB || [],
      relationDB: window.relationDB || [],
      userDB: window.userDB || [],
      globalConfig: window.globalConfig || { bgmUrl: "", volume: 0.5 },
      updatedAt: Date.now()
    };

    console.log("ğŸ“¤ Firebaseë¡œ ë°ì´í„° ì „ì†¡ ì¤‘...", dataToSave);

    set(ref(db, 'characters'), dataToSave)
      .then(() => console.log("âœ… Firebase ì €ì¥ ì„±ê³µ!"))
      .catch((error) => console.error("âŒ Firebase ì €ì¥ ì‹¤íŒ¨:", error));
  };

  // [ì¤‘ìš”] ë¶ˆëŸ¬ì˜¤ê¸° ë° ì‹¤ì‹œê°„ ë™ê¸°í™”
  onValue(ref(db, 'characters'), (snapshot) => {
    const data = snapshot.val();
    
    if (data) {
      console.log("ğŸ“¥ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì‹ í–ˆìŠµë‹ˆë‹¤.");
      
      // ì„œë²„ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ë°˜ì˜
      window.charDB = data.charDB || [];
      window.categoryDB = data.categoryDB || [];
window.termDB = data.termDB || [];
window.relationDB = data.relationDB || [];

// [ìˆ˜ì •ë¨] ì„œë²„ ë°ì´í„°ì™€ ê¸°ë³¸ ê´€ë¦¬ì ë°ì´í„°ë¥¼ í•©ì¹˜ëŠ” ë¡œì§
const serverUsers = data.userDB || [];
const defaultUsers = [
    { code: "Ero_|v|0I2)^/", name: "ëª¨ë Œ" },
    { code: "AdAstra", name: "ì•„ìŠ¤íŠ¸ë¼" },
    { code: "ToRose", name: "ë¡œìŠ¤" }
];

// ì„œë²„ ë°ì´í„°ì— ê¸°ë³¸ ê´€ë¦¬ìê°€ ì—†ìœ¼ë©´ ì¶”ê°€í•´ì¤€ë‹¤
defaultUsers.forEach(def => {
    if (!serverUsers.some(u => u.code === def.code)) {
        serverUsers.push(def);
    }
});
window.userDB = serverUsers;

window.globalConfig = data.globalConfig || { bgmUrl: "", volume: 0.5 };
      // í™”ë©´ ê°±ì‹  í•¨ìˆ˜ë“¤ í˜¸ì¶œ
      if (typeof window.renderCategories === "function") window.renderCategories();
      if (typeof window.renderCharList === "function") window.renderCharList();
      if (typeof window.renderTerms === "function") window.renderTerms();
      if (typeof window.renderRelSidebar === "function") window.renderRelSidebar();
      
      // ì„¤ì •(BGM ë“±)ì´ ìˆë‹¤ë©´ ì ìš©
      if (window.globalConfig && typeof window.changeVolume === 'function') {
         const volInput = document.getElementById('set-bgm-vol');
         if(volInput) volInput.value = window.globalConfig.volume;
      }

    } else {
      console.log("â“ ì„œë²„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ë¡œì»¬ ë°ì´í„°ë¥¼ ì„œë²„ì— ì—…ë¡œë“œí•˜ì—¬ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
      window.saveToFirebase();
    }
  });
</script>

<body>

<div id="app">
<div id="user-status" style="display: none;">
    <div class="music-control">
        <div class="music-visualizer music-paused" id="music-viz">
            <div class="music-bar"></div><div class="music-bar"></div>
            <div class="music-bar"></div><div class="music-bar"></div>
        </div>
        <button class="music-btn" onclick="toggleMusic()" id="music-toggle-btn">â–¶</button>
        <div id="youtube-player" style="display:none;"></div>
    </div>

    <div style="width: 8px; height: 8px; background: var(--neon-blue); border-radius: 50%; box-shadow: 0 0 10px var(--neon-blue);"></div>
    <span style="color: var(--text-sub); font-size: 11px;">OPERATOR :</span>
    <span id="user-name-display" style="color: var(--neon-blue); font-weight: bold; font-size: 14px; letter-spacing: 1px;">UNKNOWN</span>
    
    <button onclick="logout()" style="background: none; border: 1px solid #333; color: #555; font-size: 10px; padding: 2px 6px; cursor: pointer; margin-left: 10px;">EXIT</button>
</div>

<nav class="sidebar">
    <div>
        <div class="logo">AOTU<br><span style="font-size:16px; color:#fff;">TERMINAL</span></div>
        <button class="nav-btn active" onclick="showSection('list')">01. CONTESTANTS</button>
        <button class="nav-btn" onclick="showSection('world')">02. WORLD LOG</button>
        <button class="nav-btn" onclick="showSection('relation')">03. CONNECTION</button>
    </div>

    <div class="sidebar-footer" style="margin-top: auto; padding-top: 20px; border-top: 1px solid #222;">
        <button class="sys-btn" onclick="openSettings()" style="background: rgba(0,0,0,0.3); border: 1px solid #444; color: #666; width: 100%; padding: 12px; text-align: center; cursor: pointer; font-family: monospace; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s;">
            âš™ SYSTEM CONFIG
        </button>
    </div>
</nav>

    <main class="content-area">
        <section id="list" class="section active">
            <h2 class="page-title">CONTESTANT LIST</h2>
            <div style="margin-bottom: 10px; color: var(--text-sub); font-size: 12px;">CATEGORY FILTER</div>
            <div class="filter-bar" id="category-filter-container"></div>
            <div class="filter-bar">
                <button class="filter-tag" onclick="openCatModal()" style="border-color: #555; color: #aaa;">+ NEW CATEGORY</button>
                <button class="filter-tag" onclick="openInputModal(null, 1)" style="border-color: var(--neon-blue); color: var(--neon-blue); background: rgba(0,240,255,0.05); font-weight: bold; margin-left: auto;">+ REGISTER NEW OC</button>
            </div>
            <div class="card-grid" id="char-grid-container"></div>
        </section>

        <section id="detail" class="section">
            <div style="margin-bottom:20px;">
                <button class="nav-btn" onclick="showSection('list')">â—€ BACK TO LIST</button>
            </div>
            
            <div class="detail-container">
                <div class="detail-visual">
                    <div class="visual-fullbody">
                        <h1 id="detail-name-bg">NAME</h1>
                        <div id="detail-char-img"></div>
                    </div>

                    <div class="visual-portrait-area">
                        <div class="portrait-frame">
                            <div id="detail-portrait-img"></div>
                            <div style="position:absolute; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.7); color:#fff; font-size:10px; text-align:center; padding:3px;">ID PHOTO</div>
                        </div>
                        <div class="portrait-info">
                            <div style="color:var(--neon-yellow); font-weight:bold; font-size:14px; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px;">STATUS</div>
                            <div id="detail-status-text">
                                Team: <span id="detail-mini-team">-</span><br>
                                Class: <span id="detail-mini-class">Contestant</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-data">
                    <div class="detail-tabs">
                        <button class="tab-btn active" onclick="switchTab(1)">01 ID</button>
                        <button class="tab-btn" onclick="switchTab(2)">02 STORY</button>
                        <button class="tab-btn" onclick="switchTab(3)">03 META</button>
                        <button class="tab-btn" onclick="switchTab(4)">04 RELATION</button>
                        <button class="tab-edit-btn" onclick="openEditForCurrentTab()" title="Edit">âœ</button>
                    </div>

                    <div id="tab-1" class="tab-content active">
                        <h1 style="font-size: 46px; line-height: 1;">
                            <span id="detail-name">NAME</span> 
                            <span style="font-size:16px; color:var(--neon-yellow); margin-left:10px;" id="detail-team">TEAM</span>
                            <span id="detail-leader-badge"></span>
                        </h1>
                        <p id="detail-catchphrase" style="font-size: 20px; font-weight: bold; color: #fff; margin: 15px 0; font-style: italic; opacity:0.8;">"CATCHPHRASE"</p>
                        
                        <div class="data-box" style="margin-bottom:30px;">
                                <h3 style="color:var(--neon-blue); margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">PERSONAL PROFILE</h3>
                                <ul class="profile-grid" id="detail-profile-list"></ul>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-left: 2px solid var(--neon-blue);">
                            <h3 style="color: #fff; font-size: 12px; margin-bottom: 10px; opacity: 0.7;">INTRODUCTION</h3>
                            <p id="detail-intro" style="line-height: 1.6; color: #ddd; white-space: pre-wrap;">-</p>
                        </div>
                    </div>
                    <div id="tab-2" class="tab-content">
                        <div style="margin-bottom: 30px;">
                            <h3 style="color:var(--neon-yellow); margin-bottom: 10px;">PERSONALITY</h3>
                            <p id="detail-personality" style="color: var(--text-sub); line-height: 1.6; white-space: pre-wrap;">-</p>
                        </div>
                        <div style="margin-bottom: 30px;">
                            <h3 style="color:var(--neon-blue); margin-bottom: 10px;">BACKGROUND</h3>
                            <blockquote id="detail-background" style="border-left: 3px solid #444; padding-left: 15px; color: #ccc; line-height: 1.6; white-space: pre-wrap;">-</blockquote>
                        </div>
                        <div>
                            <h3 style="color:var(--text-sub); font-size: 12px; margin-bottom: 10px;">TRIVIA & ETC</h3>
                            <p id="detail-trivia" style="color: #888; font-size: 13px; white-space: pre-wrap;">-</p>
                        </div>
                    </div>

                    <div id="tab-3" class="tab-content">
                        <div class="weapon-box">
                            <h3 style="color:var(--neon-yellow); font-size:14px; letter-spacing:2px;">WEAPON & META</h3>
                            <p style="margin-top:5px; font-size:24px; font-weight: bold;"><b id="detail-meta-name">Weapon Name</b></p>
                            <p style="color:#fff; margin-top: 10px; line-height: 1.5;" id="detail-meta-desc">Description</p>
                        </div>
                        <div style="background:rgba(0,0,0,0.3); padding:20px; text-align: center;">
                            <h3 style="color:var(--neon-blue); margin-bottom: 20px;">ABILITY PARAMETERS</h3>
                            <canvas id="statCanvas" width="350" height="350" style="margin: 0 auto; display:block;"></canvas>
                        </div>
                    </div>

                    <div id="tab-4" class="tab-content">
                        <h3 style="color:var(--neon-blue); margin-bottom:15px;">SOCIAL NETWORK SETTINGS</h3>
                        <div class="rel-editor">
                            <h4 style="color:#ccc; font-size:12px; margin-bottom:10px;">ADD NEW CONNECTION</h4>
                            <div class="rel-form">
                                <div style="flex:1;">
                                    <select id="new-rel-target" class="rel-input"></select>
                                </div>
                                <div style="width:120px;">
                                    <select id="new-rel-type" class="rel-input">
                                        <option value="friendly">Friendly (ìš°í˜¸)</option>
                                        <option value="best_friend">Best Friend (ì ˆì¹œ)</option>
                                        <option value="friend">Friend (ì¹œêµ¬)</option>
                                        <option value="like">Like (í˜¸ê°)</option>
                                        <option value="lover">Lover (ì—°ì¸)</option>
                                        <option value="crush">Crush (ì§ì‚¬ë‘)</option>
                                        <option value="family">Family (ê°€ì¡±)</option>
                                        <option value="hostile">Hostile (ì ëŒ€)</option>
                                        <option value="hate">Hate (í˜ì˜¤)</option>
                                    </select>
                                </div>
                                <div style="flex:2;">
                                    <input type="text" id="new-rel-memo" class="rel-input" placeholder="Memo (ex. Rival)">
                                </div>
                                <button onclick="addRelation()" class="btn-small btn-add">ADD</button>
                            </div>
                        </div>

                        <table class="rel-table">
                            <thead>
                                <tr>
                                    <th width="25%">TARGET</th>
                                    <th width="20%">TYPE</th>
                                    <th>MEMO</th>
                                    <th width="10%">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="detail-rel-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

<div id="teamEditModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(5px);">
    <div class="modal-content" style="max-width:500px; height:auto; display:block; padding:30px;">
        <h2 style="color:var(--neon-yellow); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">EDIT TEAM DATA</h2>
        
        <input type="hidden" id="edit-team-target-name">
        
        <div class="form-group" style="margin-bottom:20px;">
            <label>TEAM DESCRIPTION</label>
            <textarea id="edit-team-desc" rows="6" placeholder="íŒ€ì˜ ëª©í‘œ, ì„±í–¥, íŠ¹ì§• ë“±ì„ ì„œìˆ í•˜ì„¸ìš”." style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:10px;"></textarea>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="saveTeamInfo()" class="btn-primary" style="width:auto; padding:10px 25px;">SAVE CHANGES</button>
            <button onclick="document.getElementById('teamEditModal').style.display='none'" class="btn-secondary" style="width:auto; padding:10px 20px;">CANCEL</button>
        </div>
    </div>
</div>

<section id="team-detail" class="section">
    <div style="margin-bottom:20px;">
       <button class="nav-btn" onclick="showSection('list')">â—€ BACK TO LIST</button>
    </div>

    <div style="display: flex; gap: 40px; height: 90%;">
       <div style="flex: 1;">
           <div id="team-info-card" style="
               background: rgba(0,0,0,0.6); 
               border: 2px solid #333; 
               height: 100%; 
               padding: 40px 30px; 
               position: relative; 
               clip-path: var(--border-cut); 
               box-shadow: 0 0 30px rgba(0,0,0,0.3);
               display: flex; 
               flex-direction: column;
           ">
               
               <button onclick="editTeamInfo()" style="
                   position: absolute; top: 20px; right: 20px;
                   background: transparent; border: 1px solid var(--neon-yellow); color: var(--neon-yellow);
                   width: 32px; height: 32px; border-radius: 4px; cursor: pointer;
                   display: flex; align-items: center; justify-content: center; font-size: 16px;
                   transition: 0.3s; z-index: 10;
               " onmouseover="this.style.background='var(--neon-yellow)'; this.style.color='#000'"
                 onmouseout="this.style.background='transparent'; this.style.color='var(--neon-yellow)'">
                   âœ
               </button>

               <h1 id="view-team-name" style="font-size: 48px; font-weight: 900; color: #fff; margin-bottom: 10px; line-height: 1; text-transform: uppercase;">TEAM NAME</h1>
               <div style="width: 50px; height: 4px; background: var(--neon-yellow); margin-bottom: 30px;" id="view-team-line"></div>
               
               <h4 style="color: var(--text-sub); margin-bottom: 15px; font-size: 12px; letter-spacing: 2px;">ARCHIVE LOG : DESCRIPTION</h4>
               
               <p id="view-team-desc" style="
                   color: #ddd; 
                   line-height: 1.8; 
                   font-size: 15px; 
                   white-space: pre-wrap; 
                   flex: 1; 
                   overflow-y: auto; 
                   padding-right: 10px;
                   margin-bottom: 20px;
               ">
                   -
               </p>

               <div style="
                   margin-top: auto;
                   border-top: 1px solid #444; 
                   padding-top: 20px;
                   width: 100%;
               ">
                   <h4 style="color: var(--neon-blue); margin-bottom: 15px;">STATISTICS</h4>
                   <ul style="color: var(--text-sub); font-size: 13px; list-style: none; line-height: 2; display: flex; justify-content: space-between;">
                       <li>MEMBERS <b id="view-team-count" style="color:#fff; display:block; font-size:18px;">0</b></li>
                       <li>LEADER <b id="view-team-leader" style="color:#fff; display:block; font-size:18px;">-</b></li>
                       <li>AVG. POWER <b id="view-team-power" style="color:#fff; display:block; font-size:18px;">-</b></li>
                   </ul>
               </div>
           </div>
       </div>

       <div style="flex: 2; overflow-y: auto;">
           <h3 style="color: var(--neon-blue); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">REGISTERED MEMBERS</h3>
           <div class="card-grid" id="team-member-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));"></div>
       </div>
   </div>
</section>

        <section id="world" class="section">
            <h2 class="page-title">WORLD ARCHIVE</h2>
            <div style="display:flex; gap:40px;">
                <div style="flex:1;">
                    <h3 style="color:var(--neon-yellow); margin-bottom:20px;">SYSTEM HISTORY</h3>
                    <div class="timeline" style="border-left: 2px solid var(--neon-blue); padding-left:25px; margin-left:10px;">
                        <div style="margin-bottom:30px; position:relative;">
                            <span style="position:absolute; left:-31px; top:5px; width:10px; height:10px; background:var(--neon-blue); transform:rotate(45deg);"></span>
                            <h4>ì œ 1íšŒ ìš”ì² ëŒ€íšŒ</h4>
                            <p style="color:var(--text-sub); font-size:13px;">ì°½ì„¸ì‹ ì˜ ìœ í¬ë¡œ ì‹œì‘ëœ ì²« ë²ˆì§¸ ì„œë°”ì´ë²Œ.</p>
                        </div>
                        <div style="margin-bottom:30px; position:relative;">
                            <span style="position:absolute; left:-31px; top:5px; width:10px; height:10px; background:var(--neon-yellow); transform:rotate(45deg);"></span>
                            <h4>í˜„ì¬ (ì œ 3íšŒ)</h4>
                            <p style="color:var(--text-sub); font-size:13px;">ê°€ì¥ ë§ì€ ì°¸ê°€ìì™€ ë³€ìˆ˜ê°€ ë°œìƒ ì¤‘ì¸ ëŒ€íšŒ.</p>
                        </div>
                    </div>
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="color:var(--neon-blue);">TERMINOLOGY</h3>
                        <button onclick="addNewTermInline()" style="background:none; border:1px solid var(--neon-blue); color:var(--neon-blue); padding:5px 10px; cursor:pointer; font-size:11px;">+ ADD TERM</button>
                    </div>
                    <div class="accordion" id="term-accordion"></div>
                </div>
            </div>
        </section>

        <section id="relation" class="section">
            <h2 class="page-title">RELATIONSHIP NETWORK</h2>
            <div class="rel-container">
                <div class="rel-sidebar" id="rel-sidebar-list"></div>
                <div id="rel-canvas-wrap">
                    <canvas id="relCanvas"></canvas>
                    <div id="rel-nodes-container"></div>
                    <div class="legend-box" id="rel-legend"></div>
                </div>
            </div>
        </section>
    </main>

<div id="password-overlay">
<audio id="bgm-player" loop></audio>
    <div style="border: 2px solid var(--neon-blue); padding: 40px; background: var(--bg-panel); border-radius: 10px; text-align: center;">
        <h2 style="color: var(--neon-blue); margin-bottom: 20px; letter-spacing: 2px;">SYSTEM ACCESS REQUIRED</h2>
        <p style="color: var(--text-sub); margin-bottom: 20px;">ì¸ê°€ëœ ì°¸ê°€ì ì½”ë“œë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.</p>
        <input type="password" id="site-password" style="
            background: #000; border: 1px solid var(--neon-blue); color: #fff; 
            padding: 10px; width: 200px; text-align: center; font-size: 1.2rem; margin-bottom: 20px;">
        <br>
        <button onclick="checkPassword()" style="
            background: var(--neon-blue); color: #000; border: none; 
            padding: 10px 30px; font-weight: bold; cursor: pointer; transition: 0.3s;">
            CONFIRM
        </button>
        <p id="pw-error" style="color: var(--neon-red); margin-top: 15px; display: none;">ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.</p>
    </div>
</div>

<div id="inputModal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <div style="padding: 0 20px; margin-bottom: 20px; color: var(--neon-blue); font-style: italic; font-weight: bold;">EDIT DATA</div>
            <button class="modal-nav-btn active" onclick="switchEditTab(1)">01 BASIC INFO</button>
            <button class="modal-nav-btn" onclick="switchEditTab(2)">02 STORY</button>
            <button class="modal-nav-btn" onclick="switchEditTab(3)">03 META & STATS</button>
        </div>

        <div class="modal-body-area">
            <input type="hidden" id="inp-id"> 

            <div id="edit-tab-1" class="edit-section active">
                <h2 style="color:var(--neon-blue); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">BASIC INFORMATION</h2>
                
                <div class="input-grid">
                    <div class="form-group" style="background: rgba(255,255,255,0.03); padding: 10px;">
                        <label style="color:var(--neon-blue);">FULL BODY IMAGE (ì „ì‹ )</label>
                        <div style="display:flex; gap:5px; flex-direction: column;">
                            <input type="file" accept="image/*" style="padding: 5px;" onchange="handleImageUploadNew(this, 'inp-img-full', 'preview-full')">
                            <input type="text" id="inp-img-url-full" placeholder="OR Image URL" oninput="handleImageUrlNew(this, 'inp-img-full', 'preview-full')">
                            <input type="hidden" id="inp-img-full"> 
                            <div id="preview-full" style="width: 100%; height: 100px; background: #000; border: 1px solid #444; background-size: cover; background-position: center; display:none; margin-top:5px;"></div>
                        </div>
                    </div>
                
                    <div class="form-group" style="background: rgba(255,255,255,0.03); padding: 10px;">
                        <label style="color:var(--neon-yellow);">PORTRAIT IMAGE (ì´ˆìƒí™”/í‰ìƒ)</label>
                        <div style="display:flex; gap:5px; flex-direction: column;">
                            <input type="file" accept="image/*" style="padding: 5px;" onchange="handleImageUploadNew(this, 'inp-img-portrait', 'preview-portrait')">
                            <input type="text" id="inp-img-url-portrait" placeholder="OR Image URL" oninput="handleImageUrlNew(this, 'inp-img-portrait', 'preview-portrait')">
                            <input type="hidden" id="inp-img-portrait"> 
                            <div id="preview-portrait" style="width: 100%; height: 100px; background: #000; border: 1px solid #444; background-size: cover; background-position: center; display:none; margin-top:5px;"></div>
                        </div>
                    </div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Name (ì´ë¦„)</label><input type="text" id="inp-name" placeholder="Character Name"></div>

    <div class="form-group"><label>English Name (ë°°ê²½ìš© ì˜ë¬¸)</label><input type="text" id="inp-eng-name" placeholder="ex) ZERO" style="color:var(--neon-yellow);"></div>
    <div class="form-group">
        <label>Affiliation (íŒ€/ì†Œì†)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select id="inp-team" style="flex:1;"></select>
                            <div style="display:flex; align-items:center; color:#fff; font-size:12px;">
                                <input type="checkbox" id="inp-leader"> LEADER
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Theme Color (ê³ ìœ  í…Œë§ˆìƒ‰)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="inp-theme-color" value="#00f0ff" style="width:50px; height:40px; padding:2px;">
                            <span style="font-size:11px; color:#666;">* ì´ë¦„ ë° í¬ì¸íŠ¸ ì»¬ëŸ¬ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
                        </div>
                    </div>
                    <div class="form-group"><label>Gender (ì„±ë³„)</label><select id="inp-gender"><option value="Male">Male</option><option value="Female">Female</option><option value="Unknown">Unknown</option></select></div>
                    <div class="form-group"><label>Age (ë‚˜ì´)</label><input type="text" id="inp-age" placeholder="ex) 17"></div>
                    <div class="form-group"><label>Birthplace (ì¶œìƒì§€)</label><input type="text" id="inp-origin" placeholder="Planet Name"></div>
                    <div class="form-group"><label>Birthday (ìƒì¼)</label><input type="text" id="inp-birth" placeholder="MM.DD"></div>
                    <div class="form-group"><label>Height (ì‹ ì¥)</label><input type="text" id="inp-height" placeholder="cm"></div>
                    <div class="form-group"><label>Weight (ì²´ì¤‘)</label><input type="text" id="inp-weight" placeholder="kg"></div>
                    <div class="form-group"><label>Blood Type (í˜ˆì•¡í˜•)</label><input type="text" id="inp-blood" placeholder="ex) O"></div>
                    <div class="form-group"><label>Horoscope (ë³„ìë¦¬)</label><input type="text" id="inp-sign" placeholder="ex) Leo"></div>
                    <div class="form-group"><label>Likes (ì¢‹ì•„í•˜ëŠ” ê²ƒ)</label><input type="text" id="inp-like" placeholder="Interests"></div>
                    <div class="form-group"><label>Food Pref (ì‹ì„±)</label><input type="text" id="inp-food" placeholder="Favorite Food"></div>
                </div>
                <div class="form-group" style="margin-bottom:15px;"><label>Catchphrase</label><input type="text" id="inp-catchphrase" placeholder="ex) ëª¨ë“  ë°©í–¥ì€ ë‚´ê°€ ê²°ì •í•œë‹¤." style="color:var(--neon-blue); font-weight:bold;"></div>
                <div class="form-group" style="margin-bottom:20px;"><label>Introduction</label><textarea id="inp-intro" rows="4" placeholder="ìºë¦­í„°ì— ëŒ€í•œ ìƒì„¸í•œ ì†Œê°œê¸€"></textarea></div>
            </div>

<div id="edit-tab-2" class="edit-section">
                <h2 style="color:var(--neon-blue); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">STORY ARCHIVE</h2>
                <div class="form-group" style="margin-bottom:15px;"><label>Personality (ì„±ê²©)</label><textarea id="inp-personality" rows="5" placeholder="ì„±ê²© ë¬˜ì‚¬"></textarea></div>
                <div class="form-group" style="margin-bottom:15px;"><label>Background (ê³¼ê±°/ë°°ê²½)</label><textarea id="inp-background" rows="5" placeholder="ê³¼ê±° ì´ì•¼ê¸°"></textarea></div>
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Trivia (ê¸°íƒ€ ì„¤ì •)</label>
                    <textarea id="inp-trivia" rows="5" placeholder="TMI, í˜¸ë¶ˆí˜¸, ë²„ë¦‡ ë“± ë‹¤ì–‘í•œ ê¸°íƒ€ ì„¤ì •ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>
            </div> <div id="edit-tab-3" class="edit-section">
                <h2 style="color:var(--neon-blue); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">META SYSTEM</h2>
                <div class="form-group" style="margin-bottom:15px;"><label>Meta Skill Name (ì›ë ¥ ìŠ¤í‚¬ëª…)</label><input type="text" id="inp-meta-name" placeholder="Skill Name" style="color:var(--neon-yellow); font-weight:bold;"></div>
                <div class="form-group" style="margin-bottom:15px;"><label>Meta/Weapon Description</label><textarea id="inp-meta-desc" rows="3" placeholder="Description of weapon and ability"></textarea></div>

                <h4 style="color: var(--neon-blue); margin-bottom: 10px; border-bottom: 1px solid #333; margin-top: 30px;">ABILITY PARAMETERS (0-10)</h4>
                <div class="input-grid">
                    <div class="form-group"><label>Attack (ê³µê²©)</label><input type="number" id="inp-stat-atk" min="0" max="10" step="0.5"></div>
                    <div class="form-group"><label>Defense (ë°©ì–´)</label><input type="number" id="inp-stat-def" min="0" max="10" step="0.5"></div>
                    <div class="form-group"><label>Speed (ì†ë„)</label><input type="number" id="inp-stat-spd" min="0" max="10" step="0.5"></div>
                    <div class="form-group"><label>Intelligence (ì§€ëŠ¥)</label><input type="number" id="inp-stat-int" min="0" max="10" step="0.5"></div>
                    <div class="form-group"><label>Potential (ì ì¬ë ¥)</label><input type="number" id="inp-stat-pot" min="0" max="10" step="0.5"></div>
                    <div class="form-group"><label>Survival (ìƒì¡´ë ¥)</label><input type="number" id="inp-stat-sur" min="0" max="10" step="0.5"></div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                <button onclick="saveCharacter()" class="btn-primary">REGISTER / UPDATE</button>
                <button onclick="closeInputModal()" class="btn-secondary">CANCEL</button>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(5px);">
    <div class="modal-content" style="max-width:500px; height:auto; display:block; padding: 30px;">
        <h2 style="color:var(--neon-blue); margin-bottom:20px; border-bottom: 1px solid #333; padding-bottom:10px;">SYSTEM SETTINGS</h2>
        
        <h4 style="color:var(--neon-yellow); margin-bottom:10px;">REGISTER NEW OPERATOR</h4>
        <div class="form-group"><label>New Access Code (ì ‘ì† ë¹„ë°€ë²ˆí˜¸)</label><input type="password" id="set-new-code" placeholder="Enter Secret Code"></div>
        <div class="form-group"><label>Operator Name (ë‹‰ë„¤ì„)</label><input type="text" id="set-new-name" placeholder="Enter Operator Name"></div>
        <button onclick="registerUser()" class="btn-primary" style="margin-bottom: 30px;">REGISTER USER</button>

        <h4 style="color:var(--neon-yellow); margin-bottom:10px;">BACKGROUND MUSIC</h4>
        <div class="form-group">
            <label>BGM URL (MP3 Link)</label>
            <input type="text" id="set-bgm-url" placeholder="https://example.com/music.mp3">
            <p style="font-size:10px; color:#666; margin-top:5px;">* ìœ íŠœë¸Œ ë§í¬ëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. mp3 íŒŒì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        </div>
        <div class="form-group"><label>Volume</label><input type="range" id="set-bgm-vol" min="0" max="1" step="0.1" value="0.3" style="width:100%;" onchange="changeVolume(this.value)"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveSettings()" class="btn-primary">SAVE SETTINGS</button>
            <button onclick="closeSettings()" class="btn-secondary">CLOSE</button>
        </div>
    </div>
</div>

<div id="catModal">
    <div class="modal-content" style="max-width:400px; height:auto; display:block;">
        <h2 style="color:var(--neon-yellow); margin-bottom:15px;">ADD CATEGORY</h2>
        <div class="form-group" style="margin-bottom:10px;"><label>Category Name</label><input type="text" id="inp-cat-name" placeholder="ex) TEAM NEW"></div>
        <div class="form-group" style="margin-bottom:20px;"><label>Category Color (Theme)</label><input type="color" id="inp-cat-color" value="#ffd700"></div>
        <div style="display:flex; gap:10px;"><button onclick="addCategory()" class="btn-primary">ADD</button><button onclick="closeCatModal()" class="btn-secondary">CANCEL</button></div>
    </div>
</div>

<script>
    /* [1] ì „ì—­ ë°ì´í„° ë² ì´ìŠ¤ ì´ˆê¸°í™” (window ê°ì²´ì— ì§ì ‘ í• ë‹¹í•˜ì—¬ ëª¨ë“ˆê³¼ ë™ê¸°í™”) */
    window.categoryDB = window.categoryDB || [
        { name: 'Moren', color: '#ffd700', description: 'ì••ë„ì ì¸ ë¬´ë ¥ì„ ìˆ­ìƒí•˜ëŠ” íŒ€. ë¦¬ë” ì¹´ì´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í˜¸ì „ì ì¸ ë©¤ë²„ë“¤ì´ ëª¨ì—¬ìˆë‹¤.' },
        { name: 'TEAM RAY', color: '#00ff88', description: 'ì •ë³´ì™€ ì „ëµì„ ì¤‘ì‹œí•˜ëŠ” íŒ€.' },
        { name: 'SOLO', color: '#888888', description: 'ì–´ë””ì—ë„ ì†í•˜ì§€ ì•Šê³  ë…ìì ìœ¼ë¡œ í–‰ë™í•˜ëŠ” ì°¸ê°€ìë“¤.' }
    ];

    window.globalConfig = window.globalConfig || { bgmUrl: "", volume: 0.5 };

    window.charDB = window.charDB || [
        { 
            id: 'char_001', name: 'ZERO', team: 'SOLO', isLeader: false, 
            gender: 'Male', age: '17', origin: 'Mining Planet 7', birth: '12.25', 
            height: '178cm', weight: '65kg', blood: 'AB', sign: 'Capricorn', 
            like: 'Quiet places, Cubes', food: 'Energy Bar', 
            metaName: 'Vector Hammer', metaDesc: 'ê°€í•´ì§€ëŠ” ì¶©ê²©ì˜ ë°©í–¥ì„ ì„ì˜ë¡œ ë¹„í‹€ì–´ íŒŒê´´ë ¥ì„ ê·¹ëŒ€í™”í•¨.', 
            catchphrase: 'ëª¨ë“  ë°©í–¥ì€ ë‚´ê°€ ê²°ì •í•œë‹¤.', 
            intro: 'ê³¼ë¬µí•˜ê³  ëƒ‰ì² í•œ ì„±ê²©ì˜ ì†Œìœ ì. ê³¼ê±° ê´‘ì‚° í–‰ì„±ì—ì„œì˜ ê¸°ì–µ ë•Œë¬¸ì— íƒ€ì¸ê³¼ì˜ êµë¥˜ë¥¼ êº¼ë¦°ë‹¤. ì˜¤ì§ ìì‹ ì˜ ëª©ì ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ëŒ€íšŒì— ì°¸ê°€í–ˆë‹¤.', 
            personality: '#ëƒ‰ì² í•¨ #ë…¼ë¦¬ì  #ë§ˆì´ì›¨ì´\nê°ì •ì„ ì˜ ë“œëŸ¬ë‚´ì§€ ì•Šìœ¼ë©° íš¨ìœ¨ì„ ì¤‘ì‹œí•œë‹¤.', 
            background: 'ê´‘ì‚° í–‰ì„± 7êµ¬ì—­ ì¶œì‹ . ë¶•ê´´ ì‚¬ê³ ì—ì„œ ìœ ì¼í•˜ê²Œ ì‚´ì•„ë‚¨ì•˜ìœ¼ë©°, ê·¸ ê³¼ì •ì—ì„œ ì›ë ¥ì˜ ê°ì„±ì„ ê²½í—˜í–ˆë‹¤.', 
            trivia: 'íë¸Œ í¼ì¦ì„ ë§ì¶”ëŠ” ê²ƒì´ ì·¨ë¯¸. ì“´ ì»¤í”¼ë¥¼ ì‹«ì–´í•¨.',
            stats: { atk: 8, def: 6, spd: 9, int: 7, pot: 5, sur: 8 } 
        },
        { 
            id: 'char_002', name: 'KAI', team: 'TEAM KING', isLeader: true, 
            gender: 'Male', age: '18', origin: 'Thunder Planet', birth: '04.14', 
            height: '182cm', weight: '72kg', blood: 'B', sign: 'Aries', 
            like: 'Sparring, Strong opponents', food: 'Spicy Meat', 
            metaName: 'Thunder Bolt', metaDesc: 'ì‹ ì²´ ëŠ¥ë ¥ì„ ì „ê¸°ë¡œ ê°•í™”í•˜ë©°, ì–‘ì†ì˜ ë„ˆí´ì„ ì´ìš©í•´ ì „ê²©ì„ ë°©ì¶œí•œë‹¤.', 
            catchphrase: 'ë§‰ì„ ìˆ˜ ìˆë‹¤ë©´ ë§‰ì•„ë´ë¼.', 
            intro: 'TEAM KINGì˜ ëŒê²©ëŒ€ì¥. ìƒê°ë³´ë‹¤ëŠ” ì£¼ë¨¹ì´ ë¨¼ì € ë‚˜ê°€ëŠ” ë‹¤í˜ˆì§ˆì´ì§€ë§Œ, ë™ë£Œë¥¼ ìƒê°í•˜ëŠ” ë§ˆìŒì€ ë”ì°í•˜ë‹¤.', 
            personality: '#ì—´í˜ˆ #ë‹¨ìˆœë¬´ì‹ #ì˜ë¦¬\në³µì¡í•œ ê²ƒì„ ì‹«ì–´í•˜ê³  ì§ê´€ì ìœ¼ë¡œ í–‰ë™í•œë‹¤.', 
            background: 'ì–´ë¦´ ì ë¶€í„° ì‹¸ì›€ì— ì²œë¶€ì ì¸ ì¬ëŠ¥ì„ ë³´ì˜€ë‹¤. ì¬ë” í–‰ì„±ì˜ íˆ¬ê¸°ì¥ì—ì„œ ì±”í”¼ì–¸ ìë¦¬ì— ì˜¬ëìœ¼ë‚˜ ë” ê°•í•œ ìƒëŒ€ë¥¼ ì°¾ì•„ ëŒ€íšŒì— ì™”ë‹¤.', 
            trivia: 'ë§¤ìš´ ìŒì‹ì„ ë¨¹ìœ¼ë©´ ì „ê¸°ê°€ ë” ê°•í•´ì§„ë‹¤ëŠ” ë£¨ë¨¸ë¥¼ ë¯¿ê³  ìˆë‹¤.',
            stats: { atk: 9.5, def: 7, spd: 8, int: 4, pot: 8, sur: 9 }
        }
    ];

    window.termDB = window.termDB || [
        { id: 't1', title: 'ì›ë ¥ (Meta Energy)', content: 'ì°¸ê°€ìê°€ ì‹œìŠ¤í…œìœ¼ë¡œë¶€í„° ë¶€ì—¬ë°›ëŠ” ê³ ìœ í•œ ì ì¬ ëŠ¥ë ¥. ê°ìì˜ ì„±ê²©ì´ë‚˜ ì†Œë§ì— ë”°ë¼ í˜•íƒœê°€ ê²°ì •ë©ë‹ˆë‹¤.', isEditing: false },
        { id: 't2', title: 'ì‹¬íŒê´€ (Arbitrators)', content: 'ëŒ€íšŒì˜ ê³µì •ì„±ì„ ê´€ë¦¬(í•˜ëŠ” ì²™ í•˜ëŠ”) ì°½ì„¸ì‹ ì˜ ëŒ€ë¦¬ì¸ë“¤. ê°•ë ¥í•œ ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤.', isEditing: false }
    ];

    window.relationDB = window.relationDB || [
        { source: 'char_001', target: 'char_002', type: 'hostile', memo: 'ì‹œë„ëŸ¬ì›Œì„œ ì‹«ìŒ' },
        { source: 'char_002', target: 'char_001', type: 'hostile', memo: 'ì¬ìˆ˜ì—†ëŠ” ë…€ì„' }
    ];
    
    // [ì¤‘ìš”] ìœ ì € DBë„ window ê°ì²´ë¡œ ê´€ë¦¬ (ìˆ˜ì •ë¨)
    window.userDB = window.userDB || [
        { code: "0102", name: "ëª¨ë Œ" },
        { code: "AdAstra", name: "ì•„ìŠ¤íŠ¸ë¼" },
        { code: "ToRose", name: "ë¡œìŠ¤" }
    ];

    const relColorMap = {
        'lover': '#ff69b4', 'crush': '#ffb6c1', 'best_friend': '#00ff00',
        'friend': '#00ff88', 'like': '#ff7f50', 'family': '#ffa500',
        'friendly': '#00f0ff', 'hostile': '#ff4444', 'hate': '#8b0000'
    };
    const relLabelMap = {
        'lover': 'LOVER', 'crush': 'CRUSH', 'best_friend': 'BEST FRIEND',
        'friend': 'FRIEND', 'like': 'LIKE', 'family': 'FAMILY',
        'friendly': 'FRIENDLY', 'hostile': 'HOSTILE', 'hate': 'HATE'
    };

    let currentFilter = 'ALL';
    let currentRelChar = null;
    let currentDetailId = null;
    let currentActiveTab = 1;

    window.onload = function() {
        renderCategories();
        renderCharList();
        renderTerms();
        renderRelSidebar();
        renderLegend();
        
        const isAuth = sessionStorage.getItem('authorized');
        const savedUser = sessionStorage.getItem('currentUser');
        if (isAuth === 'true' && savedUser) {
            updateUserUI(savedUser);
        }
    }

    window.saveAllData = function() {
        if (typeof window.saveToFirebase === 'function') {
            window.saveToFirebase();
        } else {
            console.error("Firebase ì €ì¥ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    };

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    window.handleImageUploadNew = function(input, targetId, previewId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewBox = document.getElementById(previewId);
                if(previewBox) {
                    previewBox.style.display = 'block';
                    previewBox.style.backgroundImage = `url('${e.target.result}')`;
                }
                document.getElementById(targetId).value = e.target.result;
                const urlInputId = targetId === 'inp-img-full' ? 'inp-img-url-full' : 'inp-img-url-portrait';
                const urlInput = document.getElementById(urlInputId);
                if(urlInput) urlInput.value = '';
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.handleImageUrlNew = function(input, targetId, previewId) {
        const url = input.value.trim();
        if (url) {
            const previewBox = document.getElementById(previewId);
            if(previewBox) {
                previewBox.style.display = 'block';
                previewBox.style.backgroundImage = `url('${url}')`;
            }
            document.getElementById(targetId).value = url;
        }
    };

    // --- RENDER CATEGORY ---
    function renderCategories() {
        const container = document.getElementById('category-filter-container');
        container.innerHTML = '';
        
        const totalChars = window.charDB.length;
        const totalTeams = window.categoryDB.length;

        let statHeader = document.getElementById('list-stat-header');
        if(!statHeader) {
            statHeader = document.createElement('div');
            statHeader.id = 'list-stat-header';
            statHeader.className = 'stat-header';
            container.parentNode.insertBefore(statHeader, container);
        }
        
        const currentTeamInfo = currentFilter === 'ALL' 
            ? { name: 'ALL DATABASE', desc: 'ì „ì²´ ì°¸ê°€ì ë°ì´í„°ë² ì´ìŠ¤ ì—´ëŒ ì¤‘' } 
            : window.categoryDB.find(c => c.name === currentFilter) || { name: 'UNKNOWN', desc: '' };

        statHeader.innerHTML = `
            <div class="stat-box" style="border-color: var(--neon-yellow);">
                <h4>CURRENT ACCESS</h4>
                <span style="color:var(--neon-yellow); font-size:18px;">${currentTeamInfo.name}</span>
            </div>
            <div class="stat-box">
                <h4>TOTAL CONTESTANTS</h4>
                <span>${totalChars}</span>
            </div>
            <div class="stat-box">
                <h4>ACTIVE TEAMS</h4>
                <span>${totalTeams}</span>
            </div>
        `;

        const allBtn = document.createElement('div');
        allBtn.className = `team-chip ${currentFilter === 'ALL' ? 'active' : ''}`;
        allBtn.onclick = () => { currentFilter = 'ALL'; renderCategories(); renderCharList(); };
        allBtn.innerHTML = `
            <div class="team-chip-color" style="background: ${currentFilter === 'ALL' ? '#fff' : '#333'}"></div>
            <span class="team-chip-name">ALL RECORDS</span>
            <span class="team-chip-count">${totalChars}</span>
        `;
        container.appendChild(allBtn);

        window.categoryDB.forEach(cat => {
            const count = window.charDB.filter(c => c.team === cat.name).length;
            const isActive = currentFilter === cat.name;
            
            const btn = document.createElement('div');
            btn.className = `team-chip ${isActive ? 'active' : ''}`;
            btn.onclick = () => { currentFilter = cat.name; renderCategories(); renderCharList(); };
            
            btn.innerHTML = `
                <div class="team-chip-color" style="background: ${cat.color}"></div>
                <span class="team-chip-name" style="${isActive ? 'color:'+cat.color : ''}">${cat.name}</span>
                <span class="team-chip-count">${count}</span>
            `;
            
            const infoBtn = document.createElement('div');
            infoBtn.style = "padding: 0 10px; color: #666; cursor: pointer; border-left:1px solid #333; height:100%; display:flex; align-items:center; transition:0.3s;";
            infoBtn.innerHTML = "ğŸ›ˆ";
            infoBtn.title = "View Team Detail";
            infoBtn.onclick = (e) => { e.stopPropagation(); openTeamDetail(cat.name); };
            
            btn.appendChild(infoBtn);

            const delBtn = document.createElement('div');
            delBtn.style = "padding: 0 10px; color: #666; cursor: pointer; border-left:1px solid #333; height:100%; display:flex; align-items:center; transition:0.3s;";
            delBtn.innerHTML = "Ã—";
            delBtn.onclick = (e) => { e.stopPropagation(); deleteCategory(cat.name); };

            btn.appendChild(delBtn);

            container.appendChild(btn);
        });
    }

    window.filterBy = function(catName) { currentFilter = catName; renderCategories(); renderCharList(); }
    window.openCatModal = function() { document.getElementById('catModal').style.display = 'flex'; }
    window.closeCatModal = function() { document.getElementById('catModal').style.display = 'none'; }
    
    window.addCategory = function() {
        const name = document.getElementById('inp-cat-name').value;
        const color = document.getElementById('inp-cat-color').value;

        if(name && !window.categoryDB.some(c => c.name === name)) { 
            window.categoryDB.push({ name: name, color: color }); 
            renderCategories(); 
            saveAllData();
            closeCatModal(); 
            document.getElementById('inp-cat-name').value = ''; 
        } else { alert('ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.'); }
    }

window.deleteCategory = function(catName) {
        if(confirm(`"${catName}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì†Œì†ëœ ìºë¦­í„°ëŠ” 'SOLO' íŒ€ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.`)) { 
            // 1. í•´ë‹¹ íŒ€ ìºë¦­í„°ë“¤ì„ SOLOë¡œ ì´ë™
            window.charDB.forEach(char => {
                if (char.team === catName) {
                    char.team = 'SOLO'; // í˜¹ì€ ë‹¤ë¥¸ ê¸°ë³¸ íŒ€ëª…
                }
            });

            // 2. ì¹´í…Œê³ ë¦¬ ì‚­ì œ
            window.categoryDB = window.categoryDB.filter(c => c.name !== catName); 
            
            if(currentFilter === catName) currentFilter = 'ALL'; 
            
            saveAllData(); // ë³€ê²½ëœ charDBì™€ categoryDB ëª¨ë‘ ì €ì¥
            renderCategories(); 
            renderCharList(); 
        }
    }

// [ìˆ˜ì •ë¨] ë©”ì¸ ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
window.renderCharList = function() {
    const container = document.getElementById('char-grid-container');
    container.innerHTML = ''; 
    
    // 1. í•„í„°ë§
    let filtered = currentFilter === 'ALL' 
        ? [...window.charDB] // ì›ë³¸ ë³´í˜¸ë¥¼ ìœ„í•´ ë³µì‚¬
        : window.charDB.filter(c => c.team === currentFilter);

    // 2. [í•µì‹¬] ë¦¬ë” ìš°ì„  ì •ë ¬ ë¡œì§ ì¶”ê°€
    filtered.sort((a, b) => {
        // ë‘˜ ë‹¤ ë¦¬ë”ê±°ë‚˜, ë‘˜ ë‹¤ ì•„ë‹ˆë©´ ìˆœì„œ ìœ ì§€ (ìƒì„±ìˆœ)
        if (!!a.isLeader === !!b.isLeader) return 0;
        // aê°€ ë¦¬ë”ë©´ ì•ìœ¼ë¡œ(-1), ì•„ë‹ˆë©´ ë’¤ë¡œ(1)
        return a.isLeader ? -1 : 1;
    });

    // 3. ë Œë”ë§
filtered.forEach(char => {
        const card = document.createElement('article');
        card.className = 'char-card';
        card.onclick = (e) => { if(!e.target.classList.contains('card-delete-btn')) openDetail(char.id); };
        
        let teamColor = '#ffd700';
        const catObj = window.categoryDB.find(c => c.name === char.team);
        if(catObj) teamColor = catObj.color;
        
        const imgToShow = char.imagePortrait || char.image;
        const bgStyle = imgToShow ? `background-image: url('${imgToShow}');` : '';

        const leaderLabel = char.isLeader 
            ? `<span style="
                font-size: 10px; 
                color: #ffd700; 
                border: 1px solid #ffd700; 
                padding: 1px 4px; 
                border-radius: 3px; 
                margin-left: 6px; 
                vertical-align: middle; 
                font-weight: normal;
               ">LEADER</span>` 
            : '';

        card.innerHTML = `
        <button class="card-delete-btn" onclick="deleteCharacter('${char.id}')">âœ•</button>
        <div class="card-team-icon" style="border-color:${teamColor}; color:${teamColor};">â—†</div>
        <div class="card-img" style="${bgStyle}"></div>
        <div class="card-info">
            <span class="card-name">${char.name} ${leaderLabel}</span>
            <span class="card-meta" style="color:${teamColor}">${char.team}</span>
            <div style="font-size:10px; color:#555; margin-top:10px;">${char.metaName}</div>
        </div>`;
        container.appendChild(card);
    });}

    window.deleteCharacter = function(id) {
        if(confirm("ì •ë§ë¡œ ì´ ë°ì´í„°ë¥¼ ì•„ì¹´ì´ë¸Œì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.charDB = window.charDB.filter(c => c.id !== id);
            window.relationDB = window.relationDB.filter(r => r.source !== id && r.target !== id);
            saveAllData();
            renderCharList(); renderRelSidebar();
        }
    }

    // --- CHARACTER INPUT & SAVE ---
    window.saveCharacter = function() {
        const id = document.getElementById('inp-id').value || ('char_' + Date.now());
        const name = document.getElementById('inp-name').value;
        const team = document.getElementById('inp-team').value;
        const engName = document.getElementById('inp-eng-name').value;

        if (!name) { alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const imgFull = document.getElementById('inp-img-full').value;
        const imgPortrait = document.getElementById('inp-img-portrait').value;

        const newChar = {
            id: id,
            name: name,
            engName: engName,
            team: team,
            image: imgFull,
            imagePortrait: imgPortrait,
            isLeader: document.getElementById('inp-leader').checked,
            themeColor: document.getElementById('inp-theme-color').value,
            gender: document.getElementById('inp-gender').value,
            age: document.getElementById('inp-age').value,
            origin: document.getElementById('inp-origin').value,
            birth: document.getElementById('inp-birth').value,
            height: document.getElementById('inp-height').value,
            weight: document.getElementById('inp-weight').value,
            blood: document.getElementById('inp-blood').value,
            sign: document.getElementById('inp-sign').value,
            like: document.getElementById('inp-like').value,
            food: document.getElementById('inp-food').value,
            metaName: document.getElementById('inp-meta-name').value,
            metaDesc: document.getElementById('inp-meta-desc').value,
            catchphrase: document.getElementById('inp-catchphrase').value,
            intro: document.getElementById('inp-intro').value,
            personality: document.getElementById('inp-personality').value,
            background: document.getElementById('inp-background').value,
            trivia: document.getElementById('inp-trivia').value,
            stats: {
                atk: Number(document.getElementById('inp-stat-atk').value) || 0,
                def: Number(document.getElementById('inp-stat-def').value) || 0,
                spd: Number(document.getElementById('inp-stat-spd').value) || 0,
                int: Number(document.getElementById('inp-stat-int').value) || 0,
                pot: Number(document.getElementById('inp-stat-pot').value) || 0,
                sur: Number(document.getElementById('inp-stat-sur').value) || 0
            }
        };

        const idx = window.charDB.findIndex(c => c.id === id);
        if (idx !== -1) { window.charDB[idx] = newChar; } else { window.charDB.push(newChar); }

        saveAllData(); 
        renderCharList();
        renderRelSidebar();
        closeInputModal();

        // í˜„ì¬ ë³´ê³  ìˆëŠ” ìºë¦­í„°ì˜€ë‹¤ë©´ ìƒì„¸ ì •ë³´ ê°±ì‹ 
        if(currentDetailId === id) openDetail(id);
    }

    window.switchTab = function(tabIdx) {
        currentActiveTab = tabIdx; 
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        const buttons = document.querySelectorAll('.tab-btn');
        if (buttons[tabIdx - 1]) buttons[tabIdx - 1].classList.add('active');
        
        const targetContent = document.getElementById('tab-' + tabIdx);
        if (targetContent) targetContent.classList.add('active');

        if (tabIdx === 3) {
            setTimeout(drawStats, 100); 
        }
    }
    
    window.openEditForCurrentTab = function() {
        const targetTab = (currentActiveTab === 4) ? 1 : currentActiveTab;
        openInputModal(currentDetailId, targetTab);
    }

    function renderDetailRelations(charId) {
        const tbody = document.getElementById('detail-rel-tbody');
        tbody.innerHTML = '';

        const related = window.relationDB.filter(r => r.source === charId || r.target === charId);

        related.forEach(rel => {
            const otherId = (rel.source === charId) ? rel.target : rel.source;
            const otherChar = window.charDB.find(c => c.id === otherId);
            
            if (otherChar) {
                const tr = document.createElement('tr');
                const typeColor = relColorMap[rel.type] || '#ccc';
                const typeLabel = relLabelMap[rel.type] || rel.type;

                tr.innerHTML = `
                    <td style="color:#fff; font-weight:bold;">${otherChar.name}</td>
                    <td><span class="rel-badge" style="color:${typeColor}; border:1px solid ${typeColor}">${typeLabel}</span></td>
                    <td style="color:#aaa;">${rel.memo}</td>
                    <td>
                        <button class="btn-del" onclick="removeRelation('${rel.source}', '${rel.target}')">âœ•</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });

        const select = document.getElementById('new-rel-target');
        select.innerHTML = '';
        window.charDB.forEach(c => {
            if(c.id !== charId) {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.innerText = c.name;
                select.appendChild(opt);
            }
        });
    }

window.openDetail = function(id) {
    currentDetailId = id;
    const char = window.charDB.find(c => c.id === id);
    if(!char) return;
    
    showSection('detail'); 
    switchTab(1); 
    
    let teamColor = '#ffd700';
    const catObj = window.categoryDB.find(c => c.name === char.team);
    if(catObj) teamColor = catObj.color;
    const charTheme = char.themeColor || '#00f0ff';

    const nameEl = document.getElementById('detail-name');
    nameEl.innerText = char.name;
    nameEl.style.color = charTheme;      
    nameEl.style.textShadow = `0 0 20px ${charTheme}`; 

    const teamEl = document.getElementById('detail-team');
    if(teamEl) {
        teamEl.innerText = char.team; 
        teamEl.style.color = teamColor;
    }

    // [ì—¬ê¸° ìˆ˜ì •ë¨] ìƒì„¸ í˜ì´ì§€ ì œëª© ì˜† ë¦¬ë” ë±ƒì§€
    const leaderBadge = document.getElementById('detail-leader-badge');
    if (char.isLeader) {
        leaderBadge.innerHTML = `<span class="leader-badge" style="background:${teamColor}; color:#000;">ğŸ‘‘ LEADER</span>`;
    } else {
        leaderBadge.innerHTML = '';
    }

    const bgNameEl = document.getElementById('detail-name-bg');
    bgNameEl.innerText = (char.engName || char.name).toUpperCase();
    bgNameEl.style.color = '#ffffff'; 

    const charImgEl = document.getElementById('detail-char-img');
    charImgEl.innerHTML = ''; 
    if(char.image) {
        const imgTag = document.createElement('img');
        imgTag.src = char.image;
        charImgEl.appendChild(imgTag);
    }

    const portraitEl = document.getElementById('detail-portrait-img');
    const portraitSrc = char.imagePortrait ? char.imagePortrait : (char.image || '');
    portraitEl.style.backgroundImage = `url('${portraitSrc}')`;

    // [ì—¬ê¸° ìˆ˜ì •ë¨] ìš°ì¸¡ ìƒë‹¨ ìƒíƒœì°½ í…ìŠ¤íŠ¸
    document.getElementById('detail-mini-team').innerText = char.team;
    document.getElementById('detail-mini-team').style.color = teamColor;
    
    const classEl = document.getElementById('detail-mini-class');
    if(classEl) {
        // ë¦¬ë”ë©´ Leader, ì•„ë‹ˆë©´ Contestant í‘œì‹œ
        classEl.innerText = char.isLeader ? "TEAM LEADER" : "CONTESTANT";
        classEl.style.color = char.isLeader ? teamColor : "var(--text-sub)";
        classEl.style.fontWeight = char.isLeader ? "bold" : "normal";
    }

    document.getElementById('detail-catchphrase').innerText = `"${char.catchphrase || 'No Catchphrase'}"`;
    document.getElementById('detail-catchphrase').style.color = charTheme; 

    document.getElementById('detail-intro').innerText = char.intro || 'No Introduction.';
    
    const profileList = document.getElementById('detail-profile-list');
    profileList.innerHTML = `<li><b>Gender:</b> ${char.gender}</li><li><b>Age:</b> ${char.age}</li><li><b>Birth:</b> ${char.birth}</li><li><b>Origin:</b> ${char.origin}</li><li><b>Height:</b> ${char.height}</li><li><b>Weight:</b> ${char.weight}</li><li><b>Blood:</b> ${char.blood}</li><li><b>Sign:</b> ${char.sign}</li><li><b>Likes:</b> ${char.like}</li><li><b>Food:</b> ${char.food}</li>`;

    document.getElementById('detail-personality').innerText = char.personality || 'No Data';
    document.getElementById('detail-background').innerText = char.background || 'No Data';
    document.getElementById('detail-trivia').innerText = char.trivia || '-';
    
    const metaNameEl = document.getElementById('detail-meta-name');
    metaNameEl.innerText = char.metaName;
    metaNameEl.style.color = charTheme; 

    document.getElementById('detail-meta-desc').innerText = char.metaDesc;
    
    renderDetailRelations(char.id);
}

    window.addRelation = function() {
        if(!currentDetailId) return;
        const targetId = document.getElementById('new-rel-target').value;
        const type = document.getElementById('new-rel-type').value;
        const memo = document.getElementById('new-rel-memo').value;

        if(!targetId) { alert('ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        const exists = window.relationDB.some(r => 
            (r.source === currentDetailId && r.target === targetId) || 
            (r.source === targetId && r.target === currentDetailId)
        );

        if(exists) {
            alert('ì´ë¯¸ ê´€ê³„ê°€ ì„¤ì •ëœ ìºë¦­í„°ì…ë‹ˆë‹¤. ìˆ˜ì •í•˜ë ¤ë©´ ê¸°ì¡´ ê´€ê³„ë¥¼ ì‚­ì œí•´ì£¼ì„¸ìš”.');
            return;
        }

        window.relationDB.push({ source: currentDetailId, target: targetId, type: type, memo: memo });
        document.getElementById('new-rel-memo').value = '';
        renderDetailRelations(currentDetailId);
        
        if(currentRelChar) drawDynamicRelations(currentRelChar);
        saveAllData();
    }

window.removeRelation = function(s, t) {
        if(confirm('ì´ ê´€ê³„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
           
            window.relationDB = window.relationDB.filter(r => 
                !((r.source === s && r.target === t) || (r.source === t && r.target === s))
            );
            
            renderDetailRelations(currentDetailId);
            if(currentRelChar) drawDynamicRelations(currentRelChar);
            saveAllData();
        }
    }

    // --- MODAL ---
    window.openInputModal = function(editId = null, startTab = 1) {
        const modal = document.getElementById('inputModal');
        const previewFull = document.getElementById('preview-full');
        const previewPortrait = document.getElementById('preview-portrait');

        const teamSelect = document.getElementById('inp-team');
        teamSelect.innerHTML = '';
        window.categoryDB.forEach(cat => { 
            const opt = document.createElement('option'); 
            opt.value = cat.name; 
            opt.innerText = cat.name; 
            teamSelect.appendChild(opt); 
        });
        
        document.getElementById('inp-id').value = editId ? editId : '';

        if(editId) {
            const char = window.charDB.find(c => c.id === editId);
            document.getElementById('inp-name').value = char.name; 
            document.getElementById('inp-eng-name').value = char.engName || '';
            
            document.getElementById('inp-img-full').value = char.image || '';
            document.getElementById('inp-img-portrait').value = char.imagePortrait || '';
            document.getElementById('inp-img-url-full').value = '';
            document.getElementById('inp-img-url-portrait').value = '';

            if(char.image) {
                previewFull.style.display = 'block';
                previewFull.style.backgroundImage = `url('${char.image}')`;
            } else { previewFull.style.display = 'none'; }

            if(char.imagePortrait) {
                previewPortrait.style.display = 'block';
                previewPortrait.style.backgroundImage = `url('${char.imagePortrait}')`;
            } else { previewPortrait.style.display = 'none'; }

            teamSelect.value = char.team; 
            document.getElementById('inp-leader').checked = char.isLeader === true;
            document.getElementById('inp-theme-color').value = char.themeColor || '#00f0ff';
            document.getElementById('inp-gender').value = char.gender; 
            document.getElementById('inp-age').value = char.age;
            document.getElementById('inp-origin').value = char.origin; 
            document.getElementById('inp-birth').value = char.birth;
            document.getElementById('inp-height').value = char.height; 
            document.getElementById('inp-weight').value = char.weight;
            document.getElementById('inp-blood').value = char.blood; 
            document.getElementById('inp-sign').value = char.sign;
            document.getElementById('inp-like').value = char.like; 
            document.getElementById('inp-food').value = char.food;
            document.getElementById('inp-meta-name').value = char.metaName; 
            document.getElementById('inp-meta-desc').value = char.metaDesc;
            document.getElementById('inp-catchphrase').value = char.catchphrase || ''; 
            document.getElementById('inp-intro').value = char.intro || '';
            document.getElementById('inp-personality').value = char.personality || ''; 
            document.getElementById('inp-background').value = char.background || '';
            document.getElementById('inp-trivia').value = char.trivia || '';

            const s = char.stats || { atk:5, def:5, spd:5, int:5, pot:5, sur:5 };
            document.getElementById('inp-stat-atk').value = s.atk;
            document.getElementById('inp-stat-def').value = s.def;
            document.getElementById('inp-stat-spd').value = s.spd;
            document.getElementById('inp-stat-int').value = s.int;
            document.getElementById('inp-stat-pot').value = s.pot;
            document.getElementById('inp-stat-sur').value = s.sur;

        } else {
            document.querySelectorAll('#inputModal input, #inputModal textarea').forEach(el => {
                if(el.type !== 'checkbox' && el.type !== 'color' && el.type !== 'hidden') el.value = '';
            });
            document.getElementById('inp-gender').value = 'Male'; 
            if(window.categoryDB.length > 0) teamSelect.value = window.categoryDB[0].name;
            document.getElementById('inp-leader').checked = false;
            document.getElementById('inp-theme-color').value = '#00f0ff'; 
            
            document.getElementById('inp-img-full').value = '';
            document.getElementById('inp-img-portrait').value = '';
            previewFull.style.display = 'none';
            previewPortrait.style.display = 'none';

            document.getElementById('inp-stat-atk').value = 5;
            document.getElementById('inp-stat-def').value = 5;
            document.getElementById('inp-stat-spd').value = 5;
            document.getElementById('inp-stat-int').value = 5;
            document.getElementById('inp-stat-pot').value = 5;
            document.getElementById('inp-stat-sur').value = 5;
        }
        
        switchEditTab(startTab); 
        modal.style.display = 'flex';
    }
    
    window.closeInputModal = function() { document.getElementById('inputModal').style.display = 'none'; }
    
    window.switchEditTab = function(idx) {
        document.querySelectorAll('.edit-section').forEach(el => el.classList.remove('active'));
        document.getElementById('edit-tab-' + idx).classList.add('active');
        
        document.querySelectorAll('.modal-nav-btn').forEach((btn, i) => {
            if(i === idx - 1) btn.classList.add('active');
            else btn.classList.remove('active');
        });
    }

    // --- TERM ACCORDION ---
    function renderTerms() {
        const container = document.getElementById('term-accordion'); container.innerHTML = '';
        window.termDB.forEach(term => {
            const item = document.createElement('div'); item.className = 'accordion-item';
            if(term.isEditing) {
                item.classList.add('open');
                item.innerHTML = `<div class="accordion-header" style="cursor:default;"><input type="text" class="inline-input-title" id="edit-title-${term.id}" value="${term.title}"><div class="term-controls"><button class="term-btn save" onclick="saveTermInline('${term.id}')">âœ“</button><button class="term-btn cancel" onclick="cancelTermInline('${term.id}')">âœ•</button></div></div><div class="accordion-content" style="padding:15px; max-height:none; border-top:1px solid #333;"><textarea class="inline-input-desc" id="edit-desc-${term.id}">${term.content}</textarea></div>`;
            } else {
                item.innerHTML = `<div class="accordion-header" onclick="toggleAccordion(this)"><span>${term.title}</span><div class="term-controls" onclick="event.stopPropagation()"><button class="term-btn edit" onclick="enableTermEdit('${term.id}')">âœ</button><button class="term-btn del" onclick="deleteTermInline('${term.id}')">ğŸ—‘</button></div></div><div class="accordion-content">${term.content}</div>`;
            }
            container.appendChild(item);
        });
    }
    window.toggleAccordion = function(header) { header.parentElement.classList.toggle('open'); }
    window.addNewTermInline = function() { const newId = 't' + Date.now(); window.termDB.unshift({ id: newId, title: 'New Term', content: '', isEditing: true }); renderTerms(); }
    window.enableTermEdit = function(id) { const idx = window.termDB.findIndex(t => t.id === id); if(idx !== -1) { window.termDB[idx].isEditing = true; renderTerms(); } }
    window.cancelTermInline = function(id) { const idx = window.termDB.findIndex(t => t.id === id); if(idx !== -1) { if(window.termDB[idx].title === 'New Term' && window.termDB[idx].content === '') window.termDB.splice(idx, 1); else window.termDB[idx].isEditing = false; renderTerms(); } }
    window.saveTermInline = function(id) { const idx = window.termDB.findIndex(t => t.id === id); if(idx !== -1) { window.termDB[idx].title = document.getElementById(`edit-title-${id}`).value; window.termDB[idx].content = document.getElementById(`edit-desc-${id}`).value; window.termDB[idx].isEditing = false; renderTerms(); saveAllData(); } }
    window.deleteTermInline = function(id) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { window.termDB = window.termDB.filter(t => t.id !== id); renderTerms(); saveAllData(); } }

    // --- RELATION GRAPH ---
    window.renderRelSidebar = function() {
        const list = document.getElementById('rel-sidebar-list'); list.innerHTML = '';
        window.charDB.forEach(char => {
            const item = document.createElement('div'); item.className = 'rel-char-item';
            item.onclick = () => selectRelChar(char.id, item);
            item.innerHTML = `<div class="rel-char-thumb"></div><span>${char.name}</span>`;
            list.appendChild(item);
        });
    }

    function renderLegend() {
        const box = document.getElementById('rel-legend');
        box.innerHTML = `<div style="color:var(--neon-blue); font-weight:bold; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:5px;">LEGEND</div>`;
        for (const [type, color] of Object.entries(relColorMap)) {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<div class="legend-color" style="background:${color};"></div> <span>${relLabelMap[type]}</span>`;
            box.appendChild(item);
        }
    }

    function selectRelChar(id, el) {
        document.querySelectorAll('.rel-char-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active'); currentRelChar = id; drawDynamicRelations(id);
    }
    
    function drawDynamicRelations(centerId) {
        const wrap = document.getElementById('rel-canvas-wrap');
        const canvas = document.getElementById('relCanvas');
        const nodeContainer = document.getElementById('rel-nodes-container');
        const ctx = canvas.getContext('2d');
        canvas.width = wrap.offsetWidth; canvas.height = wrap.offsetHeight;
        nodeContainer.innerHTML = ''; 

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const centerChar = window.charDB.find(c => c.id === centerId);
        if(!centerChar) return;

        createRelNode(centerX, centerY, centerChar.name, true);

        const processedNodes = new Set();
        processedNodes.add(centerId);

        const related = window.relationDB.filter(r => r.source === centerId || r.target === centerId);
        const uniqueRelated = [];
        related.forEach(rel => {
            const otherId = rel.source === centerId ? rel.target : rel.source;
            if (!processedNodes.has(otherId)) {
                processedNodes.add(otherId);
                uniqueRelated.push({ ...rel, otherId }); 
            }
        });

        const count = uniqueRelated.length;
        const radius = 180; 
        ctx.clearRect(0,0,canvas.width, canvas.height);

        uniqueRelated.forEach((rel, i) => {
            const otherChar = window.charDB.find(c => c.id === rel.otherId);
            if(!otherChar) return;

            const angle = (Math.PI * 2 / count) * i - Math.PI/2;
            const x = centerX + Math.cos(angle) * radius;
            const y = centerY + Math.sin(angle) * radius;

            ctx.beginPath();
            ctx.strokeStyle = relColorMap[rel.type] || '#ccc';
            ctx.lineWidth = 2;
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();

            createRelNode(x, y, otherChar.name, false, rel.type);
        });
    }

    function createRelNode(x, y, text, isMain, type='') {
        const node = document.createElement('div');
        node.className = `rel-node ${isMain ? 'main' : ''}`;
        node.style.left = x + 'px'; node.style.top = y + 'px';
        node.style.transform = 'translate(-50%, -50%)';
        node.innerText = text;
        if(!isMain) {
            const tag = document.createElement('span');
            tag.style.position = 'absolute'; tag.style.bottom = '-20px';
            tag.style.fontSize = '10px';
            tag.style.whiteSpace = 'nowrap';
            tag.style.color = relColorMap[type] || '#fff';
            tag.innerText = relLabelMap[type] || type.toUpperCase();
            node.appendChild(tag);
        }
        document.getElementById('rel-nodes-container').appendChild(node);
    }

    window.showSection = function(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const navMap = {'list':0, 'world':1, 'relation':2};
        if(navMap[id] !== undefined) document.querySelectorAll('.sidebar .nav-btn')[navMap[id]].classList.add('active');
        if(id === 'relation' && currentRelChar) drawDynamicRelations(currentRelChar);
    }

    function drawStats() {
        const c = document.getElementById("statCanvas"); 
        if(!c || !currentDetailId) return;

        const char = window.charDB.find(x => x.id === currentDetailId);
        const stats = char.stats || { atk: 5, def: 5, spd: 5, int: 5, pot: 5, sur: 5 };
        
        const dataValues = [
            stats.atk/10, stats.def/10, stats.spd/10, 
            stats.int/10, stats.pot/10, stats.sur/10
        ];
        const labels = ["ATTACK", "DEFENSE", "SPEED", "INTELLIGENCE", "POTENTIAL", "SURVIVAL"];

        const ctx = c.getContext("2d"); 
        const w = 350, h = 350; 
        const cx = w/2, cy = h/2, r = 100;

        ctx.clearRect(0,0,w,h);
        
        ctx.strokeStyle = "rgba(0, 240, 255, 0.2)"; 
        ctx.lineWidth = 1;
        
        for(let j=1; j<=5; j++){ 
            ctx.beginPath(); 
            let sr = r * (j/5); 
            for(let i=0; i<6; i++){ 
                let a = (Math.PI/3)*i - Math.PI/2; 
                const x = cx + sr*Math.cos(a); 
                const y = cy + sr*Math.sin(a); 
                if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
            } 
            ctx.closePath(); 
            ctx.stroke(); 
        }

        ctx.beginPath(); 
        dataValues.forEach((s, i) => { 
            let a = (Math.PI/3)*i - Math.PI/2; 
            const x = cx + s*r*Math.cos(a);
            const y = cy + s*r*Math.sin(a);
            if(i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y); 
        });
        ctx.closePath(); 
        ctx.fillStyle = "rgba(0, 240, 255, 0.4)"; 
        ctx.fill(); 
        ctx.strokeStyle = "var(--neon-blue)"; 
        ctx.lineWidth = 2; 
        ctx.stroke();

        ctx.fillStyle = "#fff";
        ctx.font = "bold 11px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        labels.forEach((label, i) => {
            let a = (Math.PI/3)*i - Math.PI/2;
            const x = cx + (r + 40) * Math.cos(a);
            const y = cy + (r + 40) * Math.sin(a);
            ctx.fillText(label, x, y);
        });
    }

    window.addEventListener('resize', () => { if(currentRelChar) drawDynamicRelations(currentRelChar); });

window.checkPassword = function() {
        const input = document.getElementById('site-password').value.trim();
        const foundUser = window.userDB.find(u => u.code === input);

        if (foundUser) {
            // [ê¸°ì¡´ ì˜¤ë””ì˜¤ ë¡œì§ ìœ ì§€...]
            const audio = document.getElementById('bgm-player');
            const config = window.globalConfig || { bgmUrl: "", volume: 0.5 };
            // (ì¤‘ëµ: ê¸°ì¡´ ì˜¤ë””ì˜¤ ì¬ìƒ ì½”ë“œ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤)

            alert("SYSTEM ACCESS GRANTED.\ní™˜ì˜í•©ë‹ˆë‹¤, " + foundUser.name + "ë‹˜.");
            
            sessionStorage.setItem('authorized', 'true');
            sessionStorage.setItem('currentUser', foundUser.name);
            
            updateUserUI(foundUser.name);
            document.getElementById('password-overlay').style.display = 'none'; 

            //1. ëª¨ë Œ í•´í‚¹
            if (foundUser.code === "Ero_|v|0I2)^/" || foundUser.name === "ëª¨ë Œ") {
                triggerErrorMode();
            } 
            //2. ì•„ë¥´í¬ ì ‘ì†
            else if (foundUser.code === "alstromeria" || foundUser.name === "Unknown") {
                triggerCenterPopup();
            }


        } else {
            document.getElementById('pw-error').style.display = 'block';
            document.getElementById('site-password').value = ''; 
        }
    }

    let glitchInterval = null;

    window.triggerErrorMode = function() {
        document.body.classList.add('error-mode'); //
        
        const errorMsgs = [
            "FATAL ERROR: DATA CORRUPTED",
            "UNAUTHORIZED ACCESS DETECTED",
            "SYSTEM KERNEL PANIC",
            "MEMORY LEAK: 0xFF4A2",
            "CONNECTION UNSTABLE",
            "WARNING: SECURITY BREACH"
        ];

        let count = 0;
        
        glitchInterval = setInterval(() => {
            if(count > 10) { 
                clearInterval(glitchInterval); 
                return; 
            }
            
            const msg = errorMsgs[Math.floor(Math.random() * errorMsgs.length)];
            createErrorBox(msg);
            count++;
        }, 300);

        setTimeout(() => {
            document.addEventListener('click', window.clearErrorMode, { once: true });
        }, 100);
    }

    window.clearErrorMode = function() {
        document.body.classList.remove('error-mode');

        if (glitchInterval) clearInterval(glitchInterval);

        const boxes = document.querySelectorAll('.error-popup-box');
        boxes.forEach(box => box.remove());
        
        console.log("SYSTEM RESTORED : NORMAL MODE");
    }

    function createErrorBox(text) {
        const box = document.createElement('div');
        box.className = 'error-popup-box';
        box.innerHTML = text + "<br><span style='font-size:10px; opacity:0.7'>code: " + Math.random().toString(16).substr(2, 8) + "</span>";
        
        // í™”ë©´ ë‚´ ëœë¤ ìœ„ì¹˜
        const x = Math.random() * (window.innerWidth - 200);
        const y = Math.random() * (window.innerHeight - 100);
        
        box.style.left = x + 'px';
        box.style.top = y + 'px';
        
        document.body.appendChild(box);
    }

function updateUserUI(userName) {
        const statusDiv = document.getElementById('user-status');
        const nameDisplay = document.getElementById('user-name-display');
        const loginScreen = document.getElementById('password-overlay'); 

        if (userName) {
            if(nameDisplay) nameDisplay.innerText = userName;
            if(statusDiv) statusDiv.style.display = 'flex';
            if(loginScreen) loginScreen.style.display = 'none';

            // [ì¶”ê°€ëœ ë¡œì§] ë‹‰ë„¤ì„ì— 'ì²œì‚¬'ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (userName.includes("ì²œì‚¬")) {
                document.body.classList.add('angel-mode'); // í™”ì´íŠ¸ ëª¨ë“œ ì¼œê¸°
            } else {
                document.body.classList.remove('angel-mode'); // ë„ê¸°
            }
        }
    }
    
    window.logout = function() {
        if(confirm("ì‹œìŠ¤í…œ ì ‘ì†ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            sessionStorage.removeItem('authorized');
            sessionStorage.removeItem('currentUser');
            location.reload();
        }
    }

    // --- [NEW] SETTINGS MODAL ---
    window.openSettings = function() {
        document.getElementById('set-new-code').value = '';
        document.getElementById('set-new-name').value = '';
        document.getElementById('set-bgm-url').value = window.globalConfig.bgmUrl || '';
        document.getElementById('set-bgm-vol').value = window.globalConfig.volume || 0.3;
        document.getElementById('settingsModal').style.display = 'flex';
    }

    window.closeSettings = function() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    window.registerUser = function() {
        const newCode = document.getElementById('set-new-code').value.trim();
        const newName = document.getElementById('set-new-name').value.trim();

        if(!newCode || !newName) {
            alert("ì½”ë“œì™€ ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        if(window.userDB.some(u => u.code === newCode)) {
            alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì ‘ì† ì½”ë“œì…ë‹ˆë‹¤.");
            return;
        }

        window.userDB.push({ code: newCode, name: newName });
        saveAllData();
        alert(`[ë“±ë¡ ì™„ë£Œ]\nOperator: ${newName}\nCode: ${newCode}\nì´ì œ ì´ ì½”ë“œë¡œ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        
        document.getElementById('set-new-code').value = '';
        document.getElementById('set-new-name').value = '';
    }

    let player; 
    
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function extractVideoId(url) {
        if (!url) return null;
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }

    window.onYouTubeIframeAPIReady = function() {
        console.log("âœ… ìœ íŠœë¸Œ API ë¡œë“œ ì™„ë£Œ");
        let savedId = extractVideoId(window.globalConfig.bgmUrl);
        if(!savedId || savedId === '9mU-JZFp93A') {
             savedId = '5qap5aO4i9A'; 
        }

        player = new YT.Player('youtube-player', {
            height: '0',
            width: '0',
            videoId: extractVideoId(window.globalConfig.bgmUrl) || '',
            playerVars: {
                'autoplay': 0,
                'controls': 0,
                'disablekb': 1,
                'origin': location.origin
            },
            events: {
                'onReady': onPlayerReady,
                'onError': (e) => {
                    console.error("âŒ ìœ íŠœë¸Œ ì—ëŸ¬:", e);
                    if(e.data === 150 || e.data === 101 || e.data === 153) {
                        alert("ì´ ì˜ìƒì€ ìœ íŠœë¸Œ ë°–ì—ì„œ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                }
            }
        });
    };

    function onPlayerReady(event) {
        if(event.target && event.target.setVolume) {
            event.target.setVolume(window.globalConfig.volume * 100);
        }
    }

window.toggleMusic = function() {
        const btn = document.getElementById('music-toggle-btn');
        const viz = document.getElementById('music-viz');
        const audio = document.getElementById('bgm-player'); // MP3 í”Œë ˆì´ì–´ ê°€ì ¸ì˜¤ê¸°
        
        // 1. ìœ íŠœë¸Œ í”Œë ˆì´ì–´ê°€ ìˆê³ , ì¬ìƒ ì¤‘ì¸ì§€ í™•ì¸
        let isYtPlaying = false;
        if (player && typeof player.getPlayerState === 'function') {
            if (player.getPlayerState() === 1) isYtPlaying = true;
        }

        // 2. MP3 í”Œë ˆì´ì–´ê°€ ì¬ìƒ ì¤‘ì¸ì§€ í™•ì¸
        let isAudioPlaying = !audio.paused;

        // [ë¡œì§] ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì¬ìƒ ì¤‘ì´ë©´ -> ëª¨ë‘ ì¼ì‹œì •ì§€
        if (isYtPlaying || isAudioPlaying) {
            if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
            audio.pause();
            
            btn.innerText = "â–¶";
            viz.classList.add('music-paused');
        } 
        // ë‘˜ ë‹¤ ì •ì§€ ìƒíƒœë©´ -> ì„¤ì •ëœ ì†ŒìŠ¤ì— ë”°ë¼ ì¬ìƒ
        else {
            const config = window.globalConfig || {};
            const url = config.bgmUrl || "";

            // ìœ íŠœë¸Œ URLì´ë©´ ìœ íŠœë¸Œ ì¬ìƒ
            if (url.includes('youtu') || extractVideoId(url)) {
                if (player && typeof player.playVideo === 'function') player.playVideo();
            } 
            // ì•„ë‹ˆë©´ MP3 ì¬ìƒ (URLì´ ìˆì„ ê²½ìš°)
            else if (url.length > 5) {
                audio.play().catch(e => console.log("Audio play blocked", e));
            }

            btn.innerText = "â– ";
            viz.classList.remove('music-paused');
        }
    };

    window.saveSettings = function() {
        const url = document.getElementById('set-bgm-url').value.trim();
        const vol = document.getElementById('set-bgm-vol').value;
        const videoId = extractVideoId(url);

        if (!videoId && url !== "") {
            alert("ìœ íš¨í•œ ìœ íŠœë¸Œ ì£¼ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.");
            return;
        }

        window.globalConfig.bgmUrl = url;
        window.globalConfig.volume = parseFloat(vol);
        saveAllData(); 

        if (videoId && player && typeof player.cueVideoById === 'function') {
            player.cueVideoById(videoId);
            player.setVolume(window.globalConfig.volume * 100);
            document.getElementById('music-toggle-btn').innerText = 'â–¶';
            document.getElementById('music-viz').classList.add('music-paused');
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        closeSettings();
    };

    window.changeVolume = function(val) {
        const volumeValue = parseFloat(val);
        if (typeof window.globalConfig !== 'undefined') {
            window.globalConfig.volume = volumeValue;
        }
        if (player && typeof player.setVolume === 'function') {
            player.setVolume(volumeValue * 100);
        }
    };

window.openTeamDetail = function(teamName) {
    const team = window.categoryDB.find(c => c.name === teamName);
    if(!team) return;

    // 1. ë©¤ë²„ í•„í„°ë§
    let members = window.charDB.filter(c => c.team === teamName);

    // [ìˆ˜ì •ë¨] 2. ë¦¬ë” ìš°ì„  ì •ë ¬ ë¡œì§ ì¶”ê°€
    // isLeaderê°€ trueì¸ ë©¤ë²„ë¥¼ ë°°ì—´ì˜ ì•ìœ¼ë¡œ(-1), falseë©´ ë’¤ë¡œ(1) ë³´ëƒ„
    members.sort((a, b) => {
        if (a.isLeader === b.isLeader) return 0;
        return a.isLeader ? -1 : 1;
    });

    // íŒ€ ìƒì„¸ ë·° ë³´ì´ê¸° ë° ë°ì´í„° ë°”ì¸ë”©
    showSection('team-detail'); // *ì£¼ì˜: ê¸°ì¡´ ì½”ë“œì— section ì „í™˜ì´ ë¹ ì ¸ìˆì„ ìˆ˜ ìˆì–´ ì¶”ê°€í•¨

    // íŒ€ ì •ë³´ í‘œì‹œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    document.getElementById('view-team-name').innerText = team.name;
    document.getElementById('view-team-desc').innerText = team.description || "ì•„ì§ ì‘ì„±ëœ íŒ€ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
    
    // í†µê³„ ê³„ì‚°
    const leader = members.find(c => c.isLeader);
    let totalStats = 0;
    members.forEach(m => {
        if(m.stats) {
            totalStats += (m.stats.atk + m.stats.def + m.stats.spd + m.stats.int + m.stats.pot + m.stats.sur);
        }
    });
    const avgStat = members.length > 0 ? (totalStats / members.length).toFixed(1) : 0;

    document.getElementById('view-team-count').innerText = members.length + " ëª…";
    // ë¦¬ë” ì´ë¦„ í‘œì‹œ (ì—†ìœ¼ë©´ NONE)
    document.getElementById('view-team-leader').innerText = leader ? leader.name : "NONE";
    document.getElementById('view-team-leader').style.color = leader ? team.color : "#555";
    document.getElementById('view-team-power').innerText = avgStat + " / 60";

    // 3. ë©¤ë²„ ê·¸ë¦¬ë“œ ë Œë”ë§
    const grid = document.getElementById('team-member-grid');
    grid.innerHTML = '';
    
    if(members.length === 0) {
        grid.innerHTML = `<div style="color:#666; font-style:italic; padding:20px;">ì†Œì†ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    members.forEach(char => {
        const card = document.createElement('article');
        card.className = 'char-card';
        // íŒ€ í˜ì´ì§€ì—ì„œëŠ” ì¹´ë“œë¥¼ ì¡°ê¸ˆ ì‘ê²Œ í‘œì‹œí•˜ê±°ë‚˜ ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€
        // card.style.height = '250px'; 
        
        card.onclick = () => openDetail(char.id);
        
        const imgToShow = char.imagePortrait || char.image;
        const bgStyle = imgToShow ? `background-image: url('${imgToShow}');` : '';

        // ë¦¬ë”ì¼ ê²½ìš° ì¹´ë“œì— LEADER í‘œì‹œ, ì•„ë‹ˆë©´ MEMBER
        const roleText = char.isLeader ? 'ğŸ‘‘ LEADER' : 'MEMBER';
        const roleColor = char.isLeader ? '#ffd700' : '#666';

        card.innerHTML = `
        <div class="card-img" style="${bgStyle}; height: 70%;"></div>
        <div class="card-info" style="padding:15px;">
            <span class="card-name" style="font-size:16px;">${char.name}</span>
            <span class="card-meta" style="font-size:11px; color:${roleColor}; font-weight:bold;">${roleText}</span>
        </div>`;
        grid.appendChild(card);
    });
}

    window.editTeamInfo = function() {
        const teamName = document.getElementById('view-team-name').innerText;
        const team = window.categoryDB.find(c => c.name === teamName);
        if(!team) return;

        document.getElementById('edit-team-target-name').value = teamName;
        document.getElementById('edit-team-desc').value = team.description || "";
        document.getElementById('teamEditModal').style.display = 'flex';
    }

    window.saveTeamInfo = function() {
        const teamName = document.getElementById('edit-team-target-name').value;
        const newDesc = document.getElementById('edit-team-desc').value;

        const idx = window.categoryDB.findIndex(c => c.name === teamName);
        if(idx !== -1) {
            window.categoryDB[idx].description = newDesc;
            saveAllData(); 
            openTeamDetail(teamName); 
            document.getElementById('teamEditModal').style.display = 'none'; 
        }
    }

// [ìƒˆë¡œ ì¶”ê°€] ì¤‘ì•™ ì—ëŸ¬ íŒì—… í•¨ìˆ˜
    window.triggerCenterPopup = function() {

        const overlay = document.createElement('div');
        overlay.className = 'center-error-overlay';
        overlay.id = 'mystery-overlay';
        const box = document.createElement('div');
        box.className = 'center-error-box';
        
        box.innerHTML = `
            <div class="center-error-text">Are you â– â– â– â– â– â– â– ?</div>
            <button class="center-close-btn" onclick="closeCenterPopup()">âœ• CLOSE</button>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(box);
    }

    window.closeCenterPopup = function() {
        const overlay = document.getElementById('mystery-overlay');
        const box = document.querySelector('.center-error-box');
        
        if(box) box.remove();
        if(overlay) overlay.remove();
    }


</script>
</body>
</html>